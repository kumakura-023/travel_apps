# プラン名非表示問題タスク

## 問題の概要

Firebaseとローカルストレージにプランデータが存在するにもかかわらず、プラン削除後にPlanNameDisplayが表示されない。

## 根本原因の詳細分析

### 1. プラン削除フローの問題

**PlanNameEditModal.tsx（confirmDelete関数）**

- 117行目: `const { plans } = usePlanListStore.getState();`でプラン一覧を取得
- 118行目: 削除したプランを除外してremainingを計算
- **問題**: この時点でplanListStoreにはまだ削除したプランが含まれている可能性がある
- 結果: remaining.lengthが実際より多く、プランが0件になるケースを正しく判定できない

### 2. アクティブプランID管理の不整合

- **Firestore**: usersコレクションのactivePlanId
- **ローカルストレージ**: ACTIVE_PLAN_KEY
- **問題**: 137行目で`setActivePlanId('')`を呼び出すが、これは最後のプラン削除時のみ
- 結果: 中間的な状態でアクティブプランIDが不正になる可能性

### 3. usePlanLoad.tsの残存バグ

- **30行目**: `loaded = getActivePlan() || createEmptyPlan();`
  - createEmptyPlan()が残っており、意図しない新規プラン作成の原因
- **61行目**: `setActivePlan(loaded?.id || '');`
  - loadedがnullの場合、アクティブプランIDが空文字列に設定される

### 4. 状態同期のタイミング問題

- プラン削除 → refreshPlans() → 残りプラン取得の流れで、非同期処理のタイミングによって不整合が発生
- listenToPlanの開始タイミングとデータ取得のタイミングがずれる

## 実装方針

### 1. usePlanLoad.ts の修正

```typescript
// 25-32行目を修正
let loaded: TravelPlan | null = null;
if (navigator.onLine && user) {
  loaded = await loadActivePlanHybrid({ mode: "cloud", uid: user.uid });
}
if (!loaded) {
  loaded = getActivePlan(); // createEmptyPlan()を削除
}

// 33-62行目を全面的に修正
// プランリストを取得して確認
const { plans } = usePlanListStore.getState();

if (loaded && plans.some((p) => p.id === loaded.id)) {
  // ロードしたプランが存在する場合
  console.log("[usePlanLoad] Starting to listen to loaded plan:", loaded.id);
  usePlanStore.getState().listenToPlan(loaded.id);
  usePlacesStore.setState({ places: loaded.places || [] });
  useLabelsStore.setState({ labels: loaded.labels || [] });
} else if (plans.length > 0) {
  // ロードしたプランが存在しないが、他のプランがある場合
  const firstPlan = plans[0];
  console.log(
    "[usePlanLoad] Loaded plan not found, using first available plan:",
    firstPlan.id,
  );

  // Firestoreとローカルストレージの両方を更新
  await usePlanStore.getState().setActivePlanId(firstPlan.id);
  setActivePlan(firstPlan.id);

  // リアルタイム監視を開始
  usePlanStore.getState().listenToPlan(firstPlan.id);

  // 初期データを設定（ローカルストレージから読み込み）
  const localPlan = loadPlan(firstPlan.id);
  if (localPlan) {
    usePlacesStore.setState({ places: localPlan.places || [] });
    useLabelsStore.setState({ labels: localPlan.labels || [] });
  }
} else {
  // プランが一つもない場合
  console.log("[usePlanLoad] No plans available");
  usePlanStore.getState().setPlan(null);
  usePlacesStore.setState({ places: [] });
  useLabelsStore.setState({ labels: [] });

  // アクティブプランIDをクリア
  await usePlanStore.getState().setActivePlanId("");
  setActivePlan("");
}
```

### 2. PlanNameEditModal.tsx の修正

```typescript
// confirmDelete関数（112-119行目）を修正
// プラン一覧をリフレッシュして最新の状態を取得
await refreshPlans();

// 少し待機して確実にストアが更新されるのを待つ
await new Promise((resolve) => setTimeout(resolve, 100));

// 最新のプラン一覧を取得
const { plans: latestPlans } = usePlanListStore.getState();
const remaining = latestPlans.filter((p) => p.id !== plan.id);
```

### 3. loadPlan関数の追加インポート

**usePlanLoad.ts**に以下を追加:

```typescript
import { loadPlan } from "../services/storageService";
```

## テスト項目

1. 複数プランがある状態で1つ削除 → 残りのプランが選択され、PlanNameDisplayが表示される
2. 最後のプランを削除 → プランなし状態になり、PlanNameDisplayは非表示
3. アプリをリロード → 既存のプランがある場合は自動選択され、PlanNameDisplayが表示される
4. FirestoreとローカルストレージのアクティブプランIDが常に同期している

## 影響範囲

- src/hooks/usePlanLoad.ts
- src/components/PlanNameEditModal.tsx
- src/services/storageService.ts（インポートの追加）

## 優先度

高 - ユーザーがプラン名を確認できない重大なバグ

## 作業見積もり

1-2時間（実装とテストを含む）
