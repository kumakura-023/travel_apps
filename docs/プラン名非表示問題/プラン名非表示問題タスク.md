# PlanNameDisplay非表示問題タスク

## 問題の概要

PlanNameDisplayコンポーネントが表示されなくなり、コンソールに以下のログが出力される：

```
[usePlanLoad] Starting to listen to plan: 3cefd01e-a758-4dc3-9484-b85f7c38cc82
[planStore] listenToPlan called: Object
[planStore] Plan data received: Object
[planStore] Plan not found or permission denied: 3cefd01e-a758-4dc3-9484-b85f7c38cc82
```

## 原因の特定（調査結果）

### 根本原因

PlanNameEditModalの削除処理で、Firestoreとローカルストレージのデータソースが混在していることが原因です。

### 詳細な問題の流れ

1. **プラン削除処理の問題点**
   - PlanNameEditModal.tsx（86行目）で`deletePlanFromCloud`を使ってFirestoreからプランを削除
   - その後、94行目で`getAllPlans()`を使って残りのプランを取得
   - **問題**: `getAllPlans()`はローカルストレージから取得するため、削除されたプランがまだ含まれている可能性

2. **データソースの不一致**
   - Firestoreから削除済みのプランIDで`listenToPlan`を呼び出そうとする
   - FirestoreのonSnapshotで最初はキャッシュからデータを返す（「Plan data received」）
   - その後、サーバーから最新データを取得した際にプランが存在しない（「Plan not found」）

3. **PlanNameDisplayが非表示になる理由**
   - planStore.ts（71行目）で`plan: null`がセットされる
   - PlanNameDisplay.tsx（21行目）の`if (!plan) return null;`により何も表示されない

### FirestoreとローカルストレージのデータフローMismatch

```
削除処理:
1. Firestore: プラン削除 ✓
2. ローカル: getAllPlans()で取得（削除されていない） ✗
3. 次のプランをアクティブに設定
4. listenToPlan(削除済みプランID) → エラー
```

## 具体的な修正内容

### 1. PlanNameEditModal.tsxの修正（93-105行目を置き換え）

```typescript
// 残りのプランをFirestoreから取得するように修正
const { plans } = usePlanListStore.getState();
const remaining = plans.filter((p) => p.id !== plan.id);

if (remaining.length > 0) {
  const nextPlan = remaining[0];

  // Firestoreのユーザードキュメントを更新
  await setActivePlanId(nextPlan.id);

  // ローカルストアを更新して、即座にlistenToPlanを開始
  setPlan(nextPlan);
  usePlacesStore.setState({ places: nextPlan.places || [] });
  useLabelsStore.setState({ labels: nextPlan.labels || [] });

  // 重要: 新しいプランのリアルタイム監視を開始
  usePlanStore.getState().listenToPlan(nextPlan.id);
}
```

### 2. getAllPlans()の呼び出しを削除

現在の実装：

```typescript
const remaining = getAllPlans().filter((p) => p.id !== plan.id); // ✗ ローカルストレージ
```

修正後：

```typescript
const { plans } = usePlanListStore.getState();
const remaining = plans.filter((p) => p.id !== plan.id); // ✓ Firestore経由
```

### 3. handlePlanSelect関数の修正（138-143行目）

```typescript
const handlePlanSelect = async (selectedPlan: TravelPlan) => {
  setPlan(selectedPlan);
  usePlacesStore.setState({ places: selectedPlan.places });
  useLabelsStore.setState({ labels: selectedPlan.labels });

  // Firestoreのユーザードキュメントを更新
  const { setActivePlanId } = usePlanStore.getState();
  await setActivePlanId(selectedPlan.id);

  // 選択したプランのリアルタイム監視を開始
  usePlanStore.getState().listenToPlan(selectedPlan.id);

  onClose();
};
```

### 4. savedPlansの取得方法を修正（27行目、33行目）

```typescript
// 現在の実装（useEffect内）
setSavedPlans(getAllPlans()); // ✗

// 修正後
const { plans } = usePlanListStore.getState();
setSavedPlans(plans); // ✓
```

### 5. ローカルストレージ関連の関数呼び出しを削除

以下の関数呼び出しを削除または置き換え：

- `setActivePlan(selectedPlan.id)` → `setActivePlanId(selectedPlan.id)`に置き換え
- `savePlan({ ...selectedPlan, isActive: true })` → 削除（Firestoreで管理）

## 追加で必要な修正

### 1. エラーハンドリングの改善

planStore.tsのlistenToPlan関数（69-72行目）を修正：

```typescript
if (plan) {
  set({ plan, isLoading: false, error: null });
} else {
  console.warn("[planStore] Plan not found or permission denied:", planId);
  // エラー状態にするが、即座にnullにしない（一時的な接続問題の可能性）
  set({
    isLoading: false,
    error: `Plan with ID ${planId} not found or permission denied.`,
  });
}
```

### 2. usePlanLoadの改善

権限エラーの場合の処理を追加（usePlanLoad.ts）：

```typescript
// プランのリスニング開始前に、プランリストを確認
const { plans } = usePlanListStore.getState();
const planExists = plans.some((p) => p.id === loaded.id);

if (planExists) {
  usePlanStore.getState().listenToPlan(loaded.id);
} else {
  console.warn("[usePlanLoad] Plan not found in list, creating new plan");
  // 新しいプランを作成するか、最初のプランを選択
}
```

## 実装の優先順位

1. **PlanNameEditModal.tsxの修正** - getAllPlans()の使用を止める
2. **handlePlanSelect関数の修正** - listenToPlanを追加
3. **エラーハンドリングの改善** - 一時的なエラーでUIが消えないように

## テスト項目

- [ ] プラン削除後、PlanNameDisplayが表示され続ける
- [ ] プラン削除後、次のプランが正しく表示される
- [ ] プラン切り替え時、PlanNameDisplayが正しく更新される
- [ ] コンソールに「Plan not found」エラーが出ない
- [ ] 複数デバイス間で削除・切り替えが同期される

## 期待される結果

この修正により：

1. FirestoreとローカルストレージのデータMismatchが解消される
2. プラン削除・切り替え時にPlanNameDisplayが常に表示される
3. 「Plan not found」エラーが発生しなくなる
4. データソースがFirestoreに統一される
