# 新規プラン作成問題 - 修正タスク

## 問題の概要

1. **プランが3つ存在するのに表示されない**
   - planListServiceは3つのプランを取得している
   - しかしPlanCoordinatorは「プランなし」と判断している

2. **「新しいプランを作成」ボタンが動作しない**
   - PlanNameEditModalのhandleCreateNewが古い実装のまま
   - 新しいアーキテクチャに対応していない

## 根本原因

### 1. プランリストの初期化タイミング問題

```
[PlanCoordinator] Refreshing plan list...
[PlanCoordinator] No plans available, keeping empty state
[planListServiceNoSort] Processed plans: Array(3)  // ← この後に来ている
```

PlanCoordinatorが`refreshPlans()`を呼んだ直後に`plans`を参照しているが、非同期処理が完了していない。

### 2. PlanNameEditModalが古い実装

- `createEmptyPlan`（ローカルのみ）を使用
- `setPlan`、`setActivePlanId`、`listenToPlan`（廃止予定メソッド）を使用
- 新しいPlanServiceを使用していない

## 修正内容

### Task 1: PlanCoordinator.tsの修正（最優先）

```typescript
// src/coordinators/PlanCoordinator.ts - initialize メソッドを修正

async initialize(userId: string): Promise<void> {
  console.log('[PlanCoordinator] Starting initialization for user:', userId);
  try {
    // プランリストを先に初期化して完了を待つ
    console.log('[PlanCoordinator] Refreshing plan list...');
    await usePlanListStore.getState().refreshPlans();

    // 少し待機して確実にストアが更新されるのを待つ（重要）
    await new Promise(resolve => setTimeout(resolve, 100));

    const activePlanId = await this.activePlanService.getActivePlanId(userId);
    console.log('[PlanCoordinator] Retrieved active plan ID:', activePlanId);

    // プランリストを再度取得（重要）
    const { plans } = usePlanListStore.getState();
    console.log('[PlanCoordinator] Available plans:', plans.length);

    if (activePlanId && plans.some(p => p.id === activePlanId)) {
      console.log('[PlanCoordinator] Loading and listening to plan:', activePlanId);
      await this.loadAndListenToPlan(activePlanId);
    } else if (plans.length > 0) {
      // アクティブプランがない、または無効な場合は最初のプランを選択
      console.log('[PlanCoordinator] Active plan not found, selecting first plan:', plans[0].id);
      await this.switchPlan(userId, plans[0].id);
    } else {
      console.log('[PlanCoordinator] No plans available, keeping empty state');
      this.setEmptyState();
    }

    console.log('[PlanCoordinator] Initialization completed');
  } catch (error) {
    console.error('[PlanCoordinator] Failed to initialize:', error);
    this.setErrorState(error);
  }
}
```

### Task 2: PlanCoordinatorに新規作成メソッドを追加

```typescript
// src/coordinators/PlanCoordinator.ts - 新しいメソッドを追加

async createNewPlan(userId: string, name: string): Promise<void> {
  try {
    console.log('[PlanCoordinator] Creating new plan:', name);

    // 新しいプランを作成
    const newPlan = await this.planService.createPlan(userId, name);
    console.log('[PlanCoordinator] New plan created:', newPlan.id);

    // プランリストを更新
    await usePlanListStore.getState().refreshPlans();

    // 新しいプランに切り替え
    await this.switchPlan(userId, newPlan.id);

    console.log('[PlanCoordinator] New plan creation completed');
  } catch (error) {
    console.error('[PlanCoordinator] Failed to create new plan:', error);
    this.setErrorState(error);
    throw error; // 呼び出し元でエラーハンドリングできるように
  }
}
```

### Task 3: PlanNameEditModal.tsxの新規作成処理を修正

```typescript
// src/components/PlanNameEditModal.tsx - handleCreateNew を修正

const handleCreateNew = async () => {
  const { user } = useAuthStore.getState();
  if (!user) {
    alert("ログインが必要です");
    return;
  }

  try {
    // DIコンテナから取得
    const container = DIContainer.getInstance();
    const coordinator = container.getPlanCoordinator();

    // Coordinatorを通じて新規作成
    await coordinator.createNewPlan(user.uid, "新しいプラン");

    onClose();
  } catch (error) {
    console.error("[PlanNameEditModal] Failed to create new plan:", error);
    alert("プランの作成に失敗しました。もう一度お試しください。");
  }
};
```

### Task 4: プランがない場合の新規作成も修正

PlanNameDisplay.tsxでプランがない場合に表示される「新しいプランを作成」ボタンは、PlanNameEditModalを開くだけなので、上記のhandleCreateNewの修正で動作するようになります。

ただし、モーダルが開いた時のデフォルトタブを確認：

```typescript
// src/components/PlanNameEditModal.tsx - useEffectを追加

useEffect(() => {
  if (isOpen && !plan) {
    // プランがない場合は管理タブを開く
    setActiveTab("manage");
  }
}, [isOpen, plan]);
```

### Task 5: 複製機能も新しいアーキテクチャに対応

```typescript
// src/components/PlanNameEditModal.tsx - handleDuplicate を修正

const handleDuplicate = async () => {
  const { user } = useAuthStore.getState();
  if (!user || !plan) return;

  try {
    // DIコンテナから取得
    const container = DIContainer.getInstance();
    const coordinator = container.getPlanCoordinator();
    const planService = container.getPlanService();

    // プランを複製（新規作成と同じ流れ）
    const duplicatedPlan = await planService.createPlan(
      user.uid,
      `${plan.name}_コピー`,
    );

    // 既存のデータをコピー
    duplicatedPlan.places = [...plan.places];
    duplicatedPlan.labels = [...plan.labels];
    duplicatedPlan.routes = [...plan.routes];
    duplicatedPlan.startDate = plan.startDate;
    duplicatedPlan.endDate = plan.endDate;
    duplicatedPlan.days = plan.days;

    // 保存
    await planService.savePlan(duplicatedPlan);

    // プランリストを更新
    await usePlanListStore.getState().refreshPlans();

    // 新しいプランに切り替え
    await coordinator.switchPlan(user.uid, duplicatedPlan.id);

    onClose();
  } catch (error) {
    console.error("[PlanNameEditModal] Failed to duplicate plan:", error);
    alert("プランの複製に失敗しました。もう一度お試しください。");
  }
};
```

### Task 6: DIContainerにgetPlanServiceメソッドを確認

```typescript
// src/di/DIContainer.ts - 既に存在する場合は確認のみ

getPlanService(): PlanService {
  return this.planService;
}
```

## テスト手順

1. アプリをリロード
2. コンソールログで以下を確認：
   - `[PlanCoordinator] Available plans: 3`
   - プランが正しく選択される
3. PlanNameDisplayにプラン名が表示される
4. 編集アイコンをクリックしてモーダルを開く
5. 「新規作成」ボタンで新しいプランが作成される
6. 「複製」ボタンでプランが複製される

## 期待される結果

- 既存の3つのプランのうち1つが自動的に選択される
- PlanNameDisplayにプラン名が表示される
- 新規作成・複製機能が新しいアーキテクチャで動作する
- エラーが発生しない

## 注意事項

- Firestoreのインデックスエラーは別問題（planListServiceのソート機能）
- 現在はフォールバックでソートなしのクエリが動作している
- これは機能には影響しないが、パフォーマンスのために後でインデックスを作成すべき
