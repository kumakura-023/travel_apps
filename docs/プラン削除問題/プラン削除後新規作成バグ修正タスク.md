# プラン削除後の新規作成バグ修正タスク

## 問題の概要
プランを削除した後、必ず新しいプランが自動的に作成されてしまうバグがあります。プランが複数ある状態でも新規プランが作成される深刻な問題です。

## 原因分析（詳細調査結果）

### 1. usePlanLoad.ts - 主要な問題箇所
- **行番号：48行目**
- **問題箇所：**
  ```typescript
  if (plans.length > 0) {
    const firstPlan = plans[0];
    console.log('[usePlanLoad] Using first available plan:', firstPlan.id);
    usePlanStore.getState().listenToPlan(firstPlan.id);
    loaded = getActivePlan() || createEmptyPlan();  // ← ここが問題！
  }
  ```
- **原因：** 既に最初のプランを選択してlistenToPlanを開始しているのに、その後でgetActivePlan()を呼び出し、失敗した場合にcreateEmptyPlan()で新規作成している。これが複数プランがある状態でも新規作成される直接的な原因。

### 2. ローカルストレージとFirestoreの同期問題
- **PlanNameEditModal.tsx（confirmDelete関数）**
  - Firestoreからプランを削除（deletePlanFromCloud）
  - しかし、ローカルストレージの削除（deletePlan）は呼ばれていない
  - getAllPlans()はローカルストレージから取得するため、削除されたプランが残っている
  - これにより、削除後の残りプラン数の判定が正しく行われない

### 3. getActivePlan()の問題
- **storageService.ts（getActivePlan関数）**
  ```typescript
  export function getActivePlan(): TravelPlan | null {
    const id = getActivePlanId();  // ローカルストレージから取得
    if (!id) return null;
    return loadPlan(id);  // 削除されたプランの場合nullを返す
  }
  ```
- ローカルストレージに削除されたプランのIDが残っていると、loadPlan()がnullを返す
- これがusePlanLoad.tsでcreateEmptyPlan()をトリガーする

### 4. 最後のプランを削除した場合の処理
- **PlanNameEditModal.tsx（128-148行目）**
- 最後のプランの場合のみ新規作成するロジックは正しいが、上記の問題により正常に機能していない

## 実装方針

### 1. usePlanLoad.ts - 最優先修正
- **48行目の修正**
  ```typescript
  // 修正前
  loaded = getActivePlan() || createEmptyPlan();
  
  // 修正後（削除またはコメントアウト）
  // loaded = getActivePlan() || createEmptyPlan();  // 不要な処理を削除
  ```
- この1行を削除するだけで、複数プランがある状態での新規作成バグは解決する

### 2. ローカルストレージとFirestoreの同期改善
- **PlanNameEditModal.tsx（confirmDelete関数）**
  - Firestoreから削除後、ローカルストレージからも削除する
  - getAllPlans()の代わりに、planListStoreから最新のプラン一覧を取得する
  ```typescript
  // ローカルストレージからも削除
  deletePlan(plan.id);
  
  // プラン一覧は planListStore から取得
  const { plans } = usePlanListStore.getState();
  const remaining = plans.filter(p => p.id !== plan.id);
  ```

### 3. プランが0件の状態を許可する
- 最後のプランを削除した場合、新規作成せずにプランなしの状態にする
- プランなしの状態をアプリケーション全体で正常な状態として扱う

### 4. usePlanLoad.tsの改善
- プランが見つからない場合の処理を整理
- 不要な新規作成を削除し、エラーハンドリングを改善
  ```typescript
  if (plans.length > 0) {
    const firstPlan = plans[0];
    usePlanStore.getState().listenToPlan(firstPlan.id);
    // loaded変数への代入は不要
  } else {
    // プランなしの状態を許可（新規作成しない）
    console.log('[usePlanLoad] No plans available');
  }
  ```

### 5. テスト項目
- 複数プランがある状態で削除しても新規作成されないことを確認
- 最後のプランを削除した際に新規プランが作成されないことを確認
- プラン削除後にリロードしても正常に動作することを確認
- ローカルストレージとFirestoreのデータが同期されていることを確認

## 影響範囲
- PlanNameEditModal.tsx
- usePlanLoad.ts
- planStore.ts（プランなし状態の管理）
- 各種UIコンポーネント（プランなし状態の表示）

## 優先度
高 - ユーザー体験に直接影響する重要なバグ

## 作業見積もり
2-3時間（修正とテストを含む）