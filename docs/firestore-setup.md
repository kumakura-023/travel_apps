# Firestoreセットアップガイド

## インデックスの作成

アプリのパフォーマンスを向上させるために、以下のFirestoreインデックスを作成してください。

### 1. plansコレクション用インデックス

Firebase Console > Firestore Database > インデックス タブで以下のインデックスを作成：

#### memberIds配列とupdatedAtのソート用インデックス

```
コレクション: plans
フィールド:
  - memberIds (Array-contains)
  - updatedAt (Descending)
```

#### 設定手順

1. [Firebase Console](https://console.firebase.google.com/)にアクセス
2. プロジェクトを選択
3. 左メニューから「Firestore Database」を選択
4. 「インデックス」タブをクリック
5. 「インデックスを作成」ボタンをクリック
6. 以下の設定で作成：
   - **コレクションID**: `plans`
   - **フィールド1**: `memberIds` → `Array-contains`
   - **フィールド2**: `updatedAt` → `Descending`
7. 「作成」ボタンをクリック

### 2. 自動インデックス作成

アプリを実行した際にコンソールに表示されるインデックス作成リンクからも作成可能です：

```
The query requires an index. You can create it here: https://console.firebase.google.com/...
```

このリンクをクリックすると、必要なインデックスが自動的に設定されます。

## セキュリティルール

現在のFirestoreセキュリティルールは権限エラーを回避するため、以下のように設定されています：

- **リスト取得**: 認証済みユーザーなら全プランをリスト表示可能（クライアント側でフィルタリング）
- **個別読み取り**: プランのメンバーのみアクセス可能
- **作成・更新・削除**: 従来の権限ルールを維持

## トラブルシューティング

### 権限エラーが発生する場合

1. **ユーザー認証を確認**
   - ログインが正常に完了しているか
   - メールアドレスが検証済みか（Google認証は自動で検証済み）

2. **プランのメンバーシップを確認**
   - ユーザーが対象プランのメンバーまたはオーナーになっているか
   - `members`オブジェクトまたは`memberIds`配列に含まれているか

3. **Firestoreルールを確認**
   - 最新のルールがデプロイされているか
   - ブラウザの開発者ツールでエラー詳細を確認

### パフォーマンスが悪い場合

1. **インデックスの作成状況を確認**
   - Firebase Console > Firestore Database > インデックス で作成状況を確認
   - 「作成中」状態のインデックスがないか確認

2. **クエリの最適化**
   - クライアント側フィルタリングを最小限に抑制
   - 必要に応じてサーバー側クエリを改善

## 更新履歴

- 2024-XX-XX: 初期版作成
- 権限エラー対応のためのlist権限追加
- planListServiceのエラーハンドリング改善
