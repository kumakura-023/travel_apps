# 懸念点・トレードオフ整理

## 1. API関連

### 1.1 Place Details API の課金

| 懸念     | 詳細                                                               |
| -------- | ------------------------------------------------------------------ |
| リスク   | リッチサジェストで上位3件に Details を取得するため、課金が増加する |
| 影響度   | 中                                                                 |
| 発生確率 | 高（仕様通りの動作）                                               |

**トレードオフ分析**:
| 選択肢 | メリット | デメリット |
|--------|---------|-----------|
| A: 上位3件に Details 取得（採用） | UX向上、写真・評価表示 | 課金増加 |
| B: Details 取得なし | 課金最小 | テキストのみ、判断材料不足 |
| C: ホバー時のみ取得 | 課金抑制 | モバイルで使えない、遅延発生 |

**決定**: 選択肢A採用。UX向上の価値が課金増加を上回る。

**緩和策**:

- 取得件数を3件に限定
- フィールドを必要最小限に
- キャッシュ活用で重複取得を防止

---

### 1.2 Nearby Search の結果品質

| 懸念     | 詳細                                                                    |
| -------- | ----------------------------------------------------------------------- |
| リスク   | `tourist_attraction` タイプだけでは観光地が十分に取得できない地域がある |
| 影響度   | 中                                                                      |
| 発生確率 | 中                                                                      |

**対策**:

1. 結果が少ない場合は Text Search にフォールバック
2. 複数タイプの組み合わせ検索を検討

```typescript
// フォールバック例
const spots = await nearbySearch(location, { type: "tourist_attraction" });
if (spots.length < 5) {
  const textSpots = await textSearch(`${cityName} 観光スポット`);
  // マージ処理
}
```

---

### 1.3 API レート制限

| 懸念     | 詳細                                   |
| -------- | -------------------------------------- |
| リスク   | 高頻度の検索でレート制限に達する可能性 |
| 影響度   | 高                                     |
| 発生確率 | 低（通常使用では問題なし）             |

**対策**:

- debounce 300ms
- エラー発生時のリトライ戦略（指数バックオフ）
- `OVER_QUERY_LIMIT` 時のユーザー通知

---

## 2. UX関連

### 2.1 リッチ詳細の読み込み遅延

| 懸念     | 詳細                                                         |
| -------- | ------------------------------------------------------------ |
| リスク   | Place Details の取得に時間がかかり、サジェストの応答性が低下 |
| 影響度   | 中                                                           |
| 発生確率 | 中                                                           |

**対策**:

1. **段階的表示**: 予測結果を先に表示し、詳細は非同期で追加

```
[ユーザー入力] → [予測結果表示（即座）] → [詳細追加表示（0.5-1秒後）]
```

2. **スケルトンUI**: 詳細読み込み中はスケルトン表示

```typescript
// RichSuggestionItem
{detail ? (
  <img src={getPhotoUrl(detail.photos[0])} />
) : (
  <div className="w-12 h-12 bg-slate-200 animate-pulse rounded-lg" />
)}
```

---

### 2.2 写真がない場所の表示

| 懸念     | 詳細                                         |
| -------- | -------------------------------------------- |
| リスク   | 一部の場所には写真がなく、表示が不統一になる |
| 影響度   | 低                                           |
| 発生確率 | 中                                           |

**対策**:

- プレースホルダー画像の使用
- タイプに応じたデフォルトアイコン

```typescript
const getPlaceImage = (place: PlaceResult): string => {
  if (place.photos?.length) {
    return place.photos[0].getUrl({ maxWidth: 100 });
  }
  // タイプに応じたプレースホルダー
  if (place.types?.includes("restaurant"))
    return "/placeholders/restaurant.svg";
  if (place.types?.includes("lodging")) return "/placeholders/hotel.svg";
  return "/placeholders/place.svg";
};
```

---

### 2.3 地域マスタの網羅性

| 懸念     | 詳細                                       |
| -------- | ------------------------------------------ |
| リスク   | 静的JSONでは全市区町村をカバーするのが大変 |
| 影響度   | 低                                         |
| 発生確率 | 確実                                       |

**トレードオフ分析**:
| 選択肢 | メリット | デメリット |
|--------|---------|-----------|
| A: 主要都市のみ（採用） | 実装コスト低、品質維持可能 | 地方都市が対象外 |
| B: 全市区町村 | 網羅性高 | メンテナンスコスト高、データ品質懸念 |
| C: 外部API利用 | 最新データ | 追加コスト、依存増加 |

**決定**: 選択肢A採用。主要観光地を優先し、段階的に拡張。

**初期対象（案）**:

- 北海道（札幌市、函館市、小樽市）
- 東京都（23区、八王子市、町田市）
- 神奈川県（横浜市、鎌倉市、箱根町）
- 京都府（京都市、宇治市）
- 大阪府（大阪市、堺市）
- 沖縄県（那覇市、名護市）
- ...主要観光地を含む約50都市

---

## 3. モバイル関連

### 3.1 サジェストリストの画面占有

| 懸念     | 詳細                                         |
| -------- | -------------------------------------------- |
| リスク   | モバイルでサジェストリストが画面を覆いすぎる |
| 影響度   | 中                                           |
| 発生確率 | 高                                           |

**対策**:

- BottomSheet形式で表示
- 最大5件表示に制限
- 半透明背景でキャンセル可能に

---

### 3.2 スポットグリッドのスクロール

| 懸念     | 詳細                                                         |
| -------- | ------------------------------------------------------------ |
| リスク   | 多数のスポットを表示すると、モバイルでのスクロールが重くなる |
| 影響度   | 中                                                           |
| 発生確率 | 低（20件制限で緩和）                                         |

**対策**:

- 仮想スクロール（react-window 等）の検討
- 20件以上は Load More で対応
- 画像の遅延読み込み（Intersection Observer）

---

### 3.3 タッチ操作の精度

| 懸念     | 詳細                                                 |
| -------- | ---------------------------------------------------- |
| リスク   | サジェスト行やスポットカードが小さく、タップしにくい |
| 影響度   | 中                                                   |
| 発生確率 | 中                                                   |

**対策**:

- タップ領域は最低44px確保（Apple HIG準拠）
- カード間のギャップを適切に確保
- active状態のフィードバック追加

---

## 4. 既存機能への影響

### 4.1 SearchBar の大幅改修

| 懸念     | 詳細                                                          |
| -------- | ------------------------------------------------------------- |
| リスク   | Autocomplete コンポーネント削除により、既存動作が壊れる可能性 |
| 影響度   | 高                                                            |
| 発生確率 | 中                                                            |

**対策**:

1. **段階的移行**: Feature Flag で切り替え可能に
2. **同等機能の維持確認**:
   - Enter キーでの検索確定
   - 候補選択後の地図移動
   - PlaceDetailsPanel への連携
   - inputRef の維持

3. **ロールバック準備**: 旧コードをコメントアウトではなく別ファイルに退避

---

### 4.2 selectedPlaceStore との連携

| 懸念     | 詳細                                                  |
| -------- | ----------------------------------------------------- |
| リスク   | 新しいサジェスト選択フローがStore更新を正しく行わない |
| 影響度   | 高                                                    |
| 発生確率 | 低（設計で考慮済み）                                  |

**確認ポイント**:

- `setPlace()` が呼ばれているか
- `PlaceResult` の形式が既存と同一か
- 必須フィールドが欠けていないか

---

## 5. パフォーマンス

### 5.1 Bundle サイズ増加

| 懸念     | 詳細                                            |
| -------- | ----------------------------------------------- |
| リスク   | 新コンポーネント・Store追加でBundleサイズが増加 |
| 影響度   | 低                                              |
| 発生確率 | 確実                                            |

**予想増加量**:

- 新コンポーネント: ~20KB
- 地域マスタJSON: ~50KB（50都市の場合）
- Store: ~5KB

**緩和策**:

- 地域マスタの動的インポート
- コード分割（React.lazy）

```typescript
// 地域マスタの遅延読み込み
const loadCities = async (prefCode: string) => {
  const module = await import(`../data/regions/cities/${prefCode}.json`);
  return module.default;
};
```

---

### 5.2 メモリ使用量

| 懸念     | 詳細                               |
| -------- | ---------------------------------- |
| リスク   | キャッシュが肥大化してメモリを圧迫 |
| 影響度   | 低                                 |
| 発生確率 | 低                                 |

**対策**:

- キャッシュにTTL設定（5分）
- キャッシュサイズ上限設定（100件）

```typescript
private pruneCache(): void {
  if (this.detailsCache.size > 100) {
    const oldest = Array.from(this.detailsCache.entries())
      .sort((a, b) => a[1].timestamp - b[1].timestamp)
      .slice(0, 50);
    oldest.forEach(([key]) => this.detailsCache.delete(key));
  }
}
```

---

## 6. 将来の拡張性

### 6.1 カテゴリ検索の追加

| 考慮事項     | 対応                               |
| ------------ | ---------------------------------- |
| 現在の設計   | `CategoryFilterChips` で基盤は用意 |
| 拡張ポイント | Nearby Search の type パラメータ   |
| 懸念         | カテゴリ増加時のUI設計             |

---

### 6.2 ランキング機能

| 考慮事項     | 対応                                        |
| ------------ | ------------------------------------------- |
| データソース | Google Places は評価のみ、ランキングAPIなし |
| 代替案       | rating × user_ratings_total でソート        |
| 懸念         | 「人気順」の定義が曖昧                      |

---

### 6.3 お気に入り地域

| 考慮事項  | 対応                                     |
| --------- | ---------------------------------------- |
| Store設計 | regionSearchStore に favorites 追加可能  |
| 永続化    | localStorage または Firebase             |
| UI        | 地域選択モーダルに「お気に入り」タブ追加 |

---

## 7. リスクマトリクス

| リスク                            | 影響度 | 発生確率 | 優先度 | 対策状況           |
| --------------------------------- | ------ | -------- | ------ | ------------------ |
| API課金増加                       | 中     | 高       | A      | 設計で対策済み     |
| SearchBar改修によるリグレッション | 高     | 中       | A      | Feature Flag準備   |
| Details取得遅延                   | 中     | 中       | B      | 段階的表示で対応   |
| 地域マスタ網羅性                  | 低     | 確実     | C      | 段階的拡張         |
| モバイルUX劣化                    | 中     | 中       | B      | BottomSheet対応    |
| Nearby Search結果品質             | 中     | 中       | B      | フォールバック実装 |

**優先度**:

- A: 実装前に対策必須
- B: 実装中に対策
- C: 運用で改善可能

---

## 8. 判断が必要な項目

### 8.1 debounce 時間

| 選択肢            | メリット        | デメリット      |
| ----------------- | --------------- | --------------- |
| 200ms             | 応答性高い      | API呼び出し増加 |
| **300ms（推奨）** | バランス良い    | -               |
| 500ms             | API呼び出し削減 | 応答性低下      |

### 8.2 リッチ詳細取得件数

| 選択肢          | メリット       | デメリット   |
| --------------- | -------------- | ------------ |
| 1件             | 課金最小       | 比較材料不足 |
| **3件（推奨）** | 比較可能       | 課金増       |
| 5件             | より多くの情報 | 課金大幅増   |

### 8.3 地域スポット表示件数

| 選択肢           | メリット     | デメリット      |
| ---------------- | ------------ | --------------- |
| 10件             | 軽量         | 選択肢少ない    |
| **20件（推奨）** | 適度な選択肢 | -               |
| 60件（全ページ） | 最大情報     | 重い、API課金増 |

---

## 9. 未決定事項

| 項目                              | 現状   | 決定期限       |
| --------------------------------- | ------ | -------------- |
| 地域マスタの初期対象都市リスト    | 案のみ | Phase 2 開始前 |
| モバイルBottomSheetの既存実装有無 | 要調査 | Phase 4 開始前 |
| 写真プレースホルダーのデザイン    | 未定   | Phase 1 実装中 |
