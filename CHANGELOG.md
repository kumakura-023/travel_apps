# CHANGELOG

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [1.2.19] - 2025-01-03

### 🔄 大幅リファクタリング
- **モバイル版BottomSheet**: 単一責任原則に基づく完全なコードリファクタリングを実施
  - 新規 `useBottomSheet` カスタムフックを作成し、ドラッグ処理とステート管理を分離
  - `usePullToRefreshPrevention` カスタムフックでプルツーリフレッシュ防止機能を独立化
  - `PlaceDetailPanel.tsx` からBottomSheet関連のロジックを除去し、データ表示専用に特化
  - Pointer Events に変更してタッチ・マウス操作を統一的に処理
  - `useReducer` による純粋関数でのステート管理を導入

### 🎨 技術的改善
- **ドラッグ処理の最適化**: `ref.current?.setPointerCapture(e.pointerId)` でキャプチャを保持し、指がハンドル外に出ても継続操作可能
- **CSS最適化**: `touch-action: pan-y` を適用し、ブラウザのデフォルトジェスチャとの競合を解決
- **アニメーション統一**: `transition: transform .25s ease-out` で一貫したアニメーション制御
- **メモリリーク防止**: イベントリスナーの適切なクリーンアップを実装

### 🧹 保守性向上
- BottomSheet機能の再利用性を確保（他のコンポーネントでも利用可能）
- TypeScript strict mode を満たす型安全な実装
- 既存のPC/タブレット表示機能には影響なし
- コードの可読性と保守性を大幅に向上

## [1.2.9] - 2024-12-19

### 🐛 バグ修正
- **モバイル版詳細パネル**: ハンドルバーをドラッグした際にパネルが画面上部へ張り付く問題を修正
  - `bottom: 0` を常時維持し、ドラッグ中でもパネル下端を基準に高さを連続的に変化させる
  - 展開状態のみ `top: 0` を付与し、不要な `bottom-0` の重複を排除
  - クラス名とインラインスタイルの整合性を整理し、位置ズレを解消

## [1.2.8] - 2024-12-19

### ✨ 新機能
- **モバイル版詳細パネル**: iOS風ドラッグ操作による展開/縮小機能を実装
  - パネル上部のハンドルバーからのドラッグ操作に対応
  - ドラッグ中にパネルの高さがリアルタイムで変化
  - ドラッグ終了時の移動量（50px以上）に基づいて展開/縮小を判定
  - iOS風のボトムシートのような滑らかな操作感を実現
  - ハンドルバーに適切なカーソル表示（grab/grabbing）

### 🔧 技術的改善
- パネルをflexboxコンテナに変更し、ハンドルエリアとコンテンツエリアの配置を最適化
- ドラッグ中の高さ制御を動的に調整（30vh〜100vhの範囲）
- タッチイベントの`preventDefault`でブラウザデフォルト動作を抑制

## [1.2.7] - 2024-12-19

### Fixed
- **スクロール展開機能**: 超敏感な検知とデバッグ表示を追加
  - タッチ移動の検知感度を1px以上に変更（超敏感設定）
  - スマホ画面上でのデバッグ情報表示を追加
  - より詳細なタッチイベントログを実装
  - タッチイベントが正しく発火しているかを確認可能

### Added
- **デバッグ機能**: スマホでのタッチ動作確認用
  - 画面上にリアルタイムデバッグ情報表示
  - タッチ座標とデルタ値の表示
  - イベント発火状況の可視化

## [1.2.6] - 2024-12-19

### Fixed
- **スクロール展開機能**: Reactイベントハンドラーを使用した確実な動作を実現
  - `addEventListener`からReactの`onTouchStart`/`onTouchMove`に変更
  - より直接的で確実なタッチイベント検知
  - 10px以上の縦方向移動で展開をトリガー
  - デバッグ用コンソールログを追加（開発者ツールで動作確認可能）

### Changed
- イベントハンドラーをReactネイティブな方法に統一
- より安定したタッチ操作検知の実装

## [1.2.5] - 2024-12-19

### 🐛 緊急修正
- **スクロール展開機能**: Reactイベントハンドラーを使用した確実な検知に変更
  - `addEventListener`からReactの`onTouchStart`/`onTouchMove`に変更
  - より直接的で確実なタッチイベント検知
  - 10px以上の縦方向移動で展開をトリガー
  - デバッグ用コンソールログを追加（開発者ツールで動作確認可能）

### 🔧 技術的改善
- イベントハンドラーをReactネイティブな方法に統一
- より安定したタッチ操作検知

## v1.2.4 (2024-12-19)

### 🐛 バグ修正
- **スマホ版詳細パネル**: スクロール展開機能を完全修正
  - コンテンツエリアに直接タッチイベントを設定し、確実にスクロール動作を検知
  - 15px以上の縦方向移動で展開トリガー
  - 非展開状態でのみ展開機能を動作させ、展開後は通常スクロールを許可
  - プルツーリフレッシュ防止機能を分離して展開状態でのみ動作

### 🔧 技術的改善
- タッチイベントハンドラーをコンテンツエリア専用に最適化
- イベントリスナーの管理を改善

## v1.2.3 (2024-12-19)

### 🎨 UX改善
- **スマホ版詳細パネル**: スクロールベースのパネル展開機能を実装
  - クリックベースからスクロールベースの展開に変更
  - パネル内でスクロール動作（10px以上の縦方向移動）を検知すると自動展開
  - PCでのテスト用にホイールイベントも対応
  - より自然で直感的な操作性を実現

### 🔧 技術的改善
- タッチイベントハンドラーの最適化
- プルツーリフレッシュ防止機能の改善

## v1.2.1 (2024-12-19)

### 🐛 バグ修正
- **スマホ版詳細パネル**: 全画面表示機能を修正
  - パネルコンテンツをタップで確実に全画面表示に切り替わるよう改善
  - 複雑なタッチイベントハンドラーを簡略化し、安定性を向上
  - プルツーリフレッシュ防止機能を改善

### 🎨 UX改善
- 非展開状態のパネルにカーソルポインターを追加
- タップ可能であることを視覚的に明示

## v1.2.0 (2024-12-19)

### ✨ 新機能
- **スマホ版詳細パネルのUX大幅改善**
  - パネル内スクロールを制御（非展開時は無効化）
  - タッチで全画面表示への切り替え機能
  - 展開/縮小ボタンを閉じるボタンに変更
  - スマホ版での✕ボタンを非表示
  - プルツーリフレッシュを無効化

### 🔧 技術的改善
- タッチイベントハンドラーの最適化
- パネル状態管理の改善

## v1.1.0

### ✨ 新機能
- スマホ版詳細パネルのボトムシート形式
- TabNavigation表示/非表示機能
- スマホ版UI大幅改善

## [1.2.10] - 2024-12-19

### 🐛 バグ修正
- **モバイル版詳細パネル**: ドラッグ中にハンドルバーから指が離れるとパネルが動かなくなる問題を修正
  - `touchmove` / `touchend` ハンドラーをパネル全体に移動し、ドラッグ操作を継続検知
  - ハンドルバーは `touchstart` のみ担当し、以降のイベントはパネルが捕捉
  - これにより連続的な高さ変化が機能するように改善

## [1.2.11] - 2024-12-19

### 🐛 バグ修正
- **モバイル版詳細パネル**: ハンドルバーの `touchmove/touchend` が発火しないケースを修正
  - ハンドルバーに `onTouchMove` / `onTouchEnd` を再度バインド
  - パネル全体に `touch-none` を追加してブラウザのジェスチャ干渉を防止

## [1.2.12] - 2025-07-03

### 🐛 バグ修正
- **モバイル版詳細パネル**: 画像下や地点名称をタップした際にパネルが意図せず上下に僅かに移動してしまう問題を修正
  - パネルコンテナの `touch-none` を `touch-pan-y` に置き換え、デフォルトのタップ挙動を許可しつつ垂直パンのみを許容
  - これによりハンドルバー操作以外ではパネルが動作しなくなり、意図しないスクロール干渉を回避 

## [1.2.14] - 2025-01-03

### 🐛 バグ修正
- **モバイル版詳細パネル**: ハンドルバーのドラッグ処理とボタン操作の不具合を修正
  - ハンドルバーに設定されていた `touch-none` クラスを削除してタッチイベントを正常に検知
  - パネル全体とハンドルバーのイベント競合を解決し、ドラッグ操作をハンドルバーに集約
  - 閉じるボタンのタッチイベント競合を解決し、ボタンクリックを正常に機能させる
  - `stopPropagation()` によるイベント伝搬制御を追加し、意図しないドラッグ動作を防止

## [1.2.15] - 2025-01-03

### 🔄 大幅リファクタリング
- **モバイル版詳細パネル**: Google Maps風の非モーダルBottomSheetに完全リファクタリング
  - 高さベース（`height: vh`）から `transform: translateY(%)` ベースの位置制御に変更
  - 3段階スナップ（0% = 全展開、50% = 中間、100% = 折り畳み）を実装
  - ドラッグ検知を改善：ハンドルバーで `touchstart`、`window` で `touchmove/touchend` を捕捉
  - 指がハンドルバー外に出てもドラッグが継続するように修正
  - スナップ判定を最適化（0-25% → 0%, 25-75% → 50%, 75-100% → 100%）
  - 不要な state を削除（`panelHeight`, `isDragActive`, `initialPanelHeight`）
  - 新しい `sheetPercent` (0-100) による位置管理を導入
  - Tailwind クラスを整理（`touch-none` でブラウザジェスチャ防止、`touch-pan-y` でハンドルバー操作許可）
  - アニメーション統一（`transition-transform duration-300 ease-ios-default`）

### 🎨 UX改善
- よりスムーズで安定したドラッグ操作を実現
- iOS Safari / Android Chrome でのページスクロール干渉を完全に解決
- 中間状態を追加してより細かな操作が可能に

## [1.2.13] - 2025-07-03

### 🐛 バグ修正
- **モバイル版詳細パネル**: ドラッグ操作が途中で逆方向に跳ねたり僅かしか動かせない問題を解消
  - ドラッグ開始時に `panelHeight` の現在値を基準値として保持し、途中状態からの計算誤差を排除
  - ドラッグ終了時に 75vh を境界に展開/縮小を判定し、スナップ時の不安定さを改善
  - これによりハンドルバー操作が安定し、意図通りにパネルを展開/縮小できるようになった 

## [1.2.16] - 2025-07-04

### 🐛 バグ修正
- **モバイル版詳細パネル**: BottomSheet がドラッグできなくなる問題を修正
  - スナップ判定で最新のシート位置を参照するよう `sheetPercentRef` を追加
  - `handleWindowTouchEnd` でステートのスタイル値ズレを解消
  - これにより 0 / 50 / 100 % のスナップが正しく動作 

## [1.2.17] - 2025-07-04

### 🐛 バグ修正
- **モバイル版詳細パネル**: drag 終了時に isDragging が解除されない不具合を修正
  - `useCallback` で touchmove/touchend ハンドラーをメモ化し removeEventListener が機能
  - パネルが再操作不能になる問題を解消 

## [1.2.18] - 2025-07-04

### 🐛 バグ修正
- **モバイル版詳細パネル**: ハンドルバー外に指が出た瞬間ドラッグが途切れる問題を修正
  - `touchmove` / `touchend` を `document` キャプチャフェーズに移動し全イベントを捕捉
  - 上下どちらのドラッグでも連続的にパーセンテージが変化するよう改善 

## [1.2.20] - 2025-07-04

### 🐛 バグ修正
- **モバイル版詳細パネル**: iOS Safari でアドレスバーが青く縮む際に BottomSheet が 50% にリセットされる問題を修正
  - ドラッグ開始時に `viewportHeight` を固定し、`pointermove` では固定値を使用してパーセンテージを算出
  - `pointercancel` 発生時でも現位置からスナップ判定を行い、位置ズレを防止
  - `overscroll-behavior-y: contain` を `html, body` に適用し、ページ全体のプルツーリフレッシュを抑止
  - BottomSheet コンテナに `overscroll-y-contain` と `touch-pan-y` を追加し、Safari の overscroll に対応

### 🎨 UX改善
- アドレスバー伸縮中もパネルが指に追従し続けるように
- `pointercancel` が発生しても滑らかなスナップ遷移を維持

### 🧹 保守性向上
- `useBottomSheet` に `viewportHeightRef` を追加し、単一責任原則に沿ったロジック分離
- CSS ルールを整理し、ブラウザ固有の挙動を抽象化 

## [1.3.0] - 2025-07-04

### ✨ 新機能 & Refactor

- **モバイル版 BottomSheet**: Pointer Events 対応でタッチ・マウス操作を統一し、ドラッグ操作の安定性を大幅改善
- `useBottomSheet` を全面改修し、`useReducer` による純粋ステート管理 (START_DRAG / UPDATE_DRAG / END_DRAG / SET_PERCENT / EXPAND / COLLAPSE) を導入
- ドラッグ開始時に `window.innerHeight` を固定し、画面回転による不具合を解消
- Imperative API (`expand`, `collapse`, `setPercent`) を提供し、コンポーネント側の制御を簡素化
- `PlaceDetailPanel` からドラッグロジックを分離し、単一責任原則を徹底
- アクセシビリティ向上: ハンドルに `role="separator"` とキーボード操作 (Space / ArrowUp / ArrowDown) を追加
- `usePullToRefreshPrevention` を拡張し、ドラッグ中は `preventDefault` をスキップして干渉を低減

### �� バグ修正

- iOS Safari / Android Chrome でドラッグ中にプルツーリフレッシュが誤動作する問題を修正

### その他

- ESLint / TypeScript ビルドに通過するよう型定義を調整 