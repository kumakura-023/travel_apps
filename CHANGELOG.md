# CHANGELOG

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## v1.4.45 (2025-07-16)

### 🐛 バグ修正
- **地図上のメモ編集機能 (PC版)**: PC/タブレット版で、地図上のメモ（ラベル）をダブルクリックしても編集が開始されなかった問題を修正しました。
  - **原因**: PC版ではクリックすると即座にドラッグ移動モードに移行しており、ダブルクリックを判定するロジック自体が存在しませんでした。
  - **修正内容**: スマートフォン版で実装されていたタイムスタンプベースのダブルクリック判定ロジックをPC/タブレット版にも適用しました。これにより、すべてのデバイスでダブルクリックによるメモ編集が可能になり、操作性が統一されました。

## v1.4.44 (2025-07-16)

### ✨ UX改善
- **メモ編集機能の改善 (PC/タブレット)**: PCおよびタブレット版において、メモの編集方法をダブルクリック方式に変更しました。
  - **通常モード**: メモの内容がテキストとして表示されます。
  - **編集モード**: メモをダブルクリックするとテキストエリアに切り替わり、編集が可能になります。
  - **操作性の向上**: ホバー時にはカーソルが変わり、編集可能であることが視覚的にわかるようになりました。モバイル版では、従来通り直接テキストエリアをタップして編集できます。

### 🐛 バグ修正
- **ビルドエラーの修正**: `PlaceDetailPanel.tsx`内で`updatePlace`が二重に宣言されていたため発生していたビルドエラーを修正しました。
- **メモ編集の不具合修正 (PC/タブレット)**: ダブルクリックしてもメモの編集が開始されない問題を修正しました。イベントの伝播を停止させることで、意図しないコンポーネントの動作を防ぎ、確実に編集モードに切り替わるようにしました。

## v1.4.43 (2025-07-15)

### 🐛 バグ修正
- **地図の拡大バグを完全修正**: メモ（ラベル）をダブルクリックした際に、意図せず地図が拡大してしまう問題を、すべてのデバイス（PC、タブレット、スマホ）で完全に修正しました。
  - **根本原因の解決**: Reactのイベント伝播制御だけでは不十分だったため、地図のネイティブなダブルクリックイベントを直接無効化するアプローチに変更しました。
  - **実装**: `MapContainer.tsx`の`GoogleMap`コンポーネントに`disableDoubleClickZoom: true`オプションを追加し、地図本体のダブルクリックによるズーム機能を無効にしました。これにより、メモ上のダブルクリックイベントのみが正常に処理され、編集機能が正しく動作するようになりました。

## v1.4.42 (2025-07-15)

### 🐛 バグ修正
- **地図の拡大バグを修正**: メモ（ラベル）をダブルクリックして編集する際に、背景の地図が一緒に拡大されてしまう問題を修正しました。
  - `onDoubleClick`イベントハンドラに`e.preventDefault()`を追加し、ダブルクリックイベントに紐づくブラウザのデフォルト動作（地図の拡大）をキャンセルするようにしました。

## v1.4.41 (2025-07-15)

### 🐛 バグ修正
- **メモ編集機能の回復**: メモ（ラベル）をダブルクリックしても編集ダイアログが開かない問題を修正しました。
  - クリック、ダブルクリック、ドラッグの各イベントが互いに干渉しないように、`onMouseDown`イベントの処理ロジックを改善しました。
  - これにより、マウスの移動距離やクリック時間に基づいてユーザーの意図（クリック、ドラッグ）を正確に判定し、ダブルクリックイベントが確実に発火するようになりました。

## v1.4.40 (2025-07-15)

### ✨ UX/UI改善
- **ナビゲーションUIの刷新**: スマートフォン版のナビゲーションUIを全面的に改善し、より洗練された操作性を実現しました。
  - **スライド式アイコンバー**: 右端のアイコンバーが画面内外にスライドして表示/非表示されるようになりました。これにより、地図の表示領域を最大限に活用できます。
  - **開閉ボタンの改善**: アイコンバーが隠れている時も、開閉用の矢印ボタンが画面端に表示され、いつでもナビゲーションにアクセスできます。
  - **ログインアイコンの統合**: ログインボタンをアイコンバーの最上部に統合し、UIパーツを整理しました。これにより、画面上の要素が整理され、より直感的なレイアウトになりました。

## v1.4.39 (2025-07-15)

### ✨ UX改善
- **ログインUIの改善**: ログインボタンのデザインと配置を見直し、より直感的で分かりやすいUIに修正しました。
  - **デザイン**: プロジェクトのデザインルールに基づき、アイコンだけの表示から、テキストラベル（「ログイン」またはユーザー名）を含むボタン形式に変更しました。`glass-effect`スタイルを適用し、他のUIとの親和性を高めました。
  - **配置**: 画面の隅に固定で配置されていたボタンを、右上のナビゲーションコントロール群に統合しました。これにより、UIパーツとしての一体感が生まれ、ユーザーがアカウント関連の操作だと認識しやすくなりました。

## v1.4.38 (2025-07-15)

### 🐛 バグ修正
- **候補地オーバーレイのズーム時位置ずれを完全修正**: 地図の拡大・縮小時に、候補地を示すカスタムオーバーレイが正しい位置からずれてしまう問題を完全に修正しました。CSSの`transform`プロパティの適用方法を改善し、位置決めとスケーリングが互いに干渉しないようにしました。
  - `transform: translate(-50%, calc(-100% - 10px)) scale(...)` のように、位置指定と拡大・縮小を単一の`transform`プロパティに統合しました。
  - `transform-origin: 'center bottom'` を指定し、オーバーレイが常に自身の「下端中央」を基点として変形するようにしました。
  - これにより、ズームレベルに関わらず、オーバーレイは常に地図上の正しい座標にアンカーされ、位置ずれが発生しなくなりました。

## v1.4.37 (2025-07-15)

### 🐛 バグ修正 & ♻️ リファクタリング
- **候補地オーバーレイのズーム時位置ずれを修正**: 地図の拡大・縮小時に、候補地を示すカスタムオーバーレイ（情報ウィンドウ）が正しい位置からずれてしまう問題を修正しました。UIの見た目は完全に維持したまま、以下の技術的改善を行いました。
  - **Reactコンポーネントへの移行**: `google.maps.OverlayView`を直接継承し、`innerHTML`へHTML文字列を挿入する旧来の実装を廃止しました。代わりに、`@react-google-maps/api`ライブラリが提供する`<OverlayView>`コンポーネントとJSX記法を用いるモダンな実装に全面的にリファクタリングしました。
  - **正確な位置計算**: `<OverlayView>`の`getPixelPositionOffset`プロパティを活用し、オーバーレイの描画サイズに基づいて動的に表示位置を計算するように変更しました。これにより、ズームレベルを変更してもオーバーレイは常に正しい位置にアンカーされるようになり、位置ずれの問題が根本的に解決されました。
  - **保守性の向上**: コードの可読性が向上し、将来的な機能追加や修正が容易になりました。

## v1.4.36 (2025-07-15)

### 🐛 バグ修正
- **アプリケーションクラッシュの修正**: ルート接続機能（2地点間の線描画）で地点を選択する際に、`selectedPlaces`プロパティが存在しないために発生していた`TypeError: Cannot read properties of undefined (reading 'includes')`エラーを修正しました。
  - `routeConnectionsStore`の状態管理に`selectedPlaces`配列を追加し、地点選択の開始、完了、キャンセル時にこの配列が正しく更新されるようにロジックを修正しました。
  - これにより、ルート作成時の地点選択機能が正常に動作し、アプリケーションがクラッシュする問題を解消しました。

## v1.4.35 (2025-07-15)

### 🐛 バグ修正 & ♻️ リファクタリング
- **候補地オーバーレイのズーム時位置ずれを修正**: 地図の拡大・縮小時に、候補地を示すカスタムオーバーレイ（情報ウィンドウ）が正しい位置からずれてしまう問題を修正しました。UIの見た目は完全に維持したまま、以下の技術的改善を行いました。
  - **Reactコンポーネントへの移行**: `google.maps.OverlayView`を直接継承し、`innerHTML`へHTML文字列を挿入する旧来の実装を廃止しました。代わりに、`@react-google-maps/api`ライブラリが提供する`<OverlayView>`コンポーネントとJSX記法を用いるモダンな実装に全面的にリファクタリングしました。
  - **正確な位置計算**: `<OverlayView>`の`getPixelPositionOffset`プロパティを活用し、オーバーレイの描画サイズに基づいて動的に表示位置を計算するように変更しました。これにより、ズームレベルを変更してもオーバーレイは常に正しい位置にアンカーされるようになり、位置ずれの問題が根本的に解決されました。
  - **保守性の向上**: コードの可読性が向上し、将来的な機能追加や修正が容易になりました。

## v1.4.34 (2025-07-15)

### ✨ UX改善
- **メモ配置モードの改善**: メモ配置モード中にマップをクリックした際、メモが1つだけ配置され、自動的に通常モードに戻るように修正しました。これにより、意図しないメモの連続配置を防ぎます。
- **スマホ版のメモ選択状態の改善**: スマートフォンでメモを長押しした後、指を離しても選択状態（編集モード）が維持されるように修正しました。選択を解除するには、地図上の何もない領域をタップします。これにより、編集アイコンへのアクセスが容易になりました。

## v1.4.33 (2025-07-15)

### ✨ UX改善 & バグ修正
- **メモ（ラベル）操作の全面的な改善と同期機能の回復**:
  - **同期機能の回復**: メモの移動・リサイズ後に変更が同期されない問題を修正しました。
  - **直感的なドラッグ移動**: 操作アイコンではなく、メモカード本体を直接ドラッグして移動できるようになりました。
  - **操作アイコンの大型化**: 削除ボタンとリサイズハンドルのサイズを大きくし、タッチ操作の精度を向上させました。
  - **ページスクロール防止**: メモの編集中（移動、リサイズ、長押し）に、背景ページがスクロールしてしまうのを防ぐ処理を追加しました。
  - **技術的リファクタリング**: `LabelOverlay.tsx` の状態管理とイベントハンドラを全面的にリファクタリングし、コードの可読性と保守性を向上させました。

## v1.4.32 (2025-07-15)

### 🐛 バグ修正
- **スマホ版のメモ操作性の改善 (再修正)**: スマートフォンでメモ（ラベル）の移動またはリサイズする際に、背景の地図が一緒に動いてしまう問題を修正しました。
  - 複数の`useEffect`フックが互いに干渉し、意図せず地図操作が有効化されてしまう不具合を解消しました。
  - 状態管理ロジックを単一の`useEffect`に統合し、メモの「編集中」「ドラッグ中」「リサイズ中」のいずれかの状態においては、一貫して地図操作が無効になるように修正しました。

 ## v1.4.31 (2025-07-14)
   2
   3 **バグ修正**
   4
   5 *
     デバイス判定のロジックをタッチイベントベースから画面幅ベースのメディアクエリに統一し、スマートフ
     ォンでアクセスした際にデスクトップ用のレイアウトが表示される問題を修正しました。

 ## [1.4.31] - 2025-07-14

    🐛 バグ修正
   **地図操作の修正**:
    マップの操作が2本指でないとできない問題を修正し、常に1本指でのドラッグ操作が可能になるよう
     `gestureHandling` を `'greedy'` に変更しました。
   
     不要な地図コントロール（航空写真、ストリートビュー等）が再表示されていた問題を修正し、恒久的に非
     表示にしました。
  **メモ編集の修正**:
     モバイル環境で、メモ（ラベル）の長押しによる編集モードが、通常のタップでも誤って開始されてしまう
     不具合を修正しました。これにより、長押しでのみ編集モードが開始されるようになります。

## [1.4.30] - 2025-07-14

### 🐛 バグ修正
- **ビルドエラーの修正**: `LabelOverlay.tsx` ファイルが誤って文字列として保存され、Vercelでのデプロイに失敗する問題を修正しました。

## [1.4.29] - 2025-07-14

### ✨ UX改善
- **スマホ版メモ操作の抜本的改善**: スマートフォンでのメモ（ラベル）の操作性を全面的に刷新しました。
  - **長押し編集モード**: メモを長押し（500ms）すると、そのメモ専用の「編集モード」に入ります。
  - **地図操作のロック**: 編集モード中は背景の地図操作が完全に無効化され、メモの移動やリサイズに集中できます。
  - **直感的な操作UI**: 編集モードでは、移動・リサイズ・削除の操作ハンドルが表示され、誤操作なく直感的に編集を行えます。
  - **アイコンの最適化**: 地図のズームレベルに応じて、編集用アイコンの表示サイズが自動調整され、常に見やすく操作しやすくなりました。

### 🔧 技術的改善
- **PointerEventへの移行**: `LabelOverlay`コンポーネントのイベント処理を`PointerEvent`に統一し、マウスとタッチ操作の挙動を共通化しました。
- **グローバルな地図操作ロック**: `uiStore`に`isMapInteractionEnabled`状態を追加し、アプリ全体で地図操作の有効/無効を管理できるようにしました。

## [1.4.28] - 2025-07-14

### ✨ UX改善
- **チュートリアルの内容を刷新**: アプリの主要機能である「候補地」「メモ」「予算」に焦点を当てた、より実践的で分かりやすい内容に全面的に見直しました。
  - **予算に関する注意喚起**: 概算費用がGoogleマップの料金レベルに基づく「目安」であることを明記し、ユーザーの誤解を防ぐための注意書きを追加しました。

## [1.4.27] - 2025-07-14

### ✨ UX改善
- **スマホ版のメモ操作性を大幅に向上**: スマホでのメモ（ラベル）編集機能を全面的にリファクタリングしました。
  - **イベントモデルの統一**: `MouseEvent` から `PointerEvent` に移行し、タッチとマウス操作を共通化。PCとスマホで一貫した操作性を実現しました。
  - **ダブルタップ編集**: スマホでメモをダブルタップ（300ms以内の連続タップ）すると、テキスト編集ダイアログが開くようになりました。
  - **安全な移動UI**: シングルタップでメモを選択状態にし、専用の「移動ハンドル」を表示します。これにより、地図のスクロールと競合することなく、安全にメモを移動できます。

### 🐛 バグ修正
- スマホでメモの編集、リサイズ、削除ができなかった問題を修正しました。

## [1.4.26] - 2025-07-14

### ✨ UX改善
- **メモ（ラベル）の同期アルゴリズム改善**: メモの編集体験を向上させるため、同期タイミングを最適化しました。
  - 新規作成されたメモは、テキストが編集・保存されるまでクラウド同期されなくなりました。
  - これにより、メモの配置、移動、リサイズ中に意図しない同期が発生し、編集作業が妨げられる問題を解消しました。

### 🔧 技術的改善
- `MapLabel` 型に `status` プロパティを追加し、メモの同期状態（`new` | `synced`）を管理するようにしました。
- `labelsStore` と `App.tsx` の同期ロジックを修正し、`status` が `synced` のメモに対する操作のみがクラウド同期をトリガーするように変更しました。

## [1.4.25] - 2025-07-14

### ✨ UX改善
- **メモ（ラベル）の操作性向上**: メモ機能の操作感を改善しました。
  - **デフォルトサイズの拡大**: 新規作成時のメモのデフォルトサイズを `120x40` ピクセルに拡大し、視認性と操作性を向上させました。
  - **リサイズ感度の調整**: メモのサイズ変更時の感度を50%に抑制し、より繊細で正確なサイズ調整が可能になりました。

### 🐛 バグ修正
- **メモのリサイズ**: 新規作成したメモを即座にリサイズできない問題を修正しました。

## [1.4.24] - 2025-07-14

### 🐛 バグ修正
- **重大なデグレードの修正**: メモ（ラベル）を追加した後にリロードすると、地図のオーバーレイが一切表示されなくなる問題を修正しました。
  - メモ作成時に、位置情報が正しいデータ構造（`position` オブジェクト）で保存されていなかったことが原因でした。
  - `MapEventHandler.tsx` を修正し、常に正しいデータ構造でメモが作成されるようにしました。
  - これにより、リロード後のコンソールエラーとそれに伴う表示不具合が解消されます。

### ⚠️ 注意事項
- この修正は、今後作成されるメモにのみ適用されます。問題が発生したバージョンで既に作成してしまった不正なデータを含む旅行プランは、お手数ですが一度削除し、再作成していただく必要があります。

## [1.4.23] - 2025-07-14

### ✨ 新機能
- **メモ（ラベル）機能のクラウド同期**: メモ（ラベル）の追加、編集、削除がクラウド経由でリアルタイムに同期されるようになりました。

### 🐛 バグ修正
- **メモ（ラベル）の編集**: 編集内容が保存されない問題を修正しました。編集、保存後に即座にUIへ反映され、クラウドにも同期されます。

### 🔧 技術的改善
- `labelsStore`に`onLabelUpdated`コールバックを追加し、ラベルの更新イベントを捕捉できるようにしました。
- `App.tsx`でラベルの追加、更新、削除の各イベントを購読し、`planStore`の更新とクラウドへの同期処理を実装しました。
- 同期関連のテスト用ボタン（`TestPlacesButton`, `SyncTestButton`, `SyncDebugButton`）をUIから削除しました。

## [1.4.22] - 2025-07-14

### 🐛 バグ修正
- **UI同期**: 候補地の追加・削除操作直後にUIが一時的に元に戻ってしまう問題を修正しました。
  - クラウド同期処理と同時に、Zustandで管理されているローカルのプラン状態(`planStore`)も即座に更新するように変更しました。
  - これにより、UIの再描画時に古い状態が参照されることがなくなり、操作が即座にUIに反映されるようになりました。

## [1.4.21] - 2025-07-14

### 🐛 バグ修正
- **クラウド同期**: 候補地の追加が同期されない、またはいずれかの操作で初回のみ同期が失敗する問題を修正しました。
  - **候補地追加の同期**: `onPlaceAdded` コールバック内で、追加された候補地を含む最新のプラン情報を取得して同期するように修正しました。これにより、候補地の追加が確実にクラウドに反映されます。
  - **初回操作の安定化**: `onPlaceDeleted` の `useEffect` フックの依存配列に `plan` を追加しました。これにより、アプリ起動後やリロード直後の初回操作からでも、常に最新の状態で同期処理が実行されるようになり、削除操作の信頼性が向上しました。

## [1.4.20] - 2025-07-14

### 🐛 バグ修正
- **クラウド同期**: 候補地削除時のクラウド同期が正しく行われない問題を修正しました。
  - `placesStore.ts`の`onPlaceDeleted`コールバックが、削除後の最新の`places`配列を渡すように変更しました。
  - `App.tsx`の`onPlaceDeleted`コールバック内で、`usePlanStore`から取得した現在のプランに、`placesStore`から渡された最新の`places`配列をマージしてクラウド同期を行うように修正しました。
  - これにより、削除操作が完了した直後の最新の状態でクラウド同期が実行され、リロード時に削除された場所が復活する問題が解消されました。

## [1.4.19] - 2025-07-14

### 🐛 バグ修正
- **クラウド同期**: 候補地を削除してもリロードで復活する問題を根本的に解決しました。
  - 競合解決ロジック(`syncConflictResolver.ts`)が、`deleted`フラグの付いた候補地を削除対象として正しく認識していなかった問題を修正しました。
  - これにより、ローカルでの削除操作がクラウドに正しく反映され、データが意図せず元に戻る現象を解消しました。
- **デバッグログ強化**: 同期競合の分析を容易にするため、競合解決プロセスで扱われるデータの詳細なログを出力するようにしました。

## [1.4.18] - 2025-07-14

### 🐛 バグ修正
- **クラウド同期**: 候補地を削除しても、ページをリロードすると元に戻ってしまう問題を修正しました。
  - 候補地を削除する際に、実際にデータを削除するのではなく `deleted` フラグを立てるように変更しました。
  - UI上では `deleted` フラグのついた候補地をフィルタリングして非表示にします。
  - クラウド同期時に `deleted` フラグのついた候補地をプランから完全に削除することで、データの整合性を保ちます。

## [1.4.17] - 2025-07-14

### 🐛 バグ修正
- **同期競合の修正**: 候補地を削除した際に、古いデータで上書きされて削除が取り消される問題を修正しました。
  - `placesStore.ts`の`deletePlace`関数を修正し、状態が更新された後に同期コールバックが実行されるように変更しました。これにより、常に最新の状態で同期が行われ、競合が解消されます。

## [1.4.16] - 2025-07-11

### 🔧 同期問題の根本的解決
- **クラウド保存タイムスタンプ管理の改善**: 独立したタイムスタンプ管理により、保存直後の受信問題を解決
  - `cloudSaveTimestampRef`を追加し、クラウド保存完了後に正確なタイムスタンプを記録
  - 保存開始時と完了時のタイムスタンプを分離し、自己更新判定の精度を向上
  - クラウド保存タイムスタンプが0になる問題を完全解決

### 🎯 自己更新判定の最適化
- **自己更新判定の閾値を3秒に延長**: 保存直後の受信が頻繁に発生する問題を解決
  - 2秒から3秒に延長し、ネットワーク遅延とクラウド保存時間を考慮
  - リモート更新中の自動保存停止時間を300msに延長し、競合を防止
  - より安定した同期制御を実現

### ⚔️ 競合解決ロジックの強化
- **同じタイムスタンプ処理の改善**: L15-R15-Res15パターンの問題を根本的に解決
  - 1秒以内のタイムスタンプ差は同じとみなし、リモートを優先するロジックに統一
  - 地点・ラベル両方で一貫した競合解決ロジックを適用
  - 位置情報変更の検知を強化し、より正確な競合解決を実現

### 📊 同期デバッグ機能の拡張
- **位置情報更新の分析機能を追加**: より詳細な問題特定を可能に
  - 位置情報競合の検知と分析機能を追加
  - 同期品質評価に位置情報更新の分析を組み込み
  - 問題特定とデバッグの容易性を大幅向上

### 🎯 期待される効果
- 候補地追加・削除の同期成功率を大幅に向上
- 「変更が取り消されたような挙動」の根本的解決
- より安定したリアルタイム同期の実現
- 問題特定とデバッグの容易性向上

### 🔧 技術的改善
- **単一責任原則の徹底**: 各同期機能を独立したモジュールとして分離
- **インターフェース依存の実現**: 抽象的なインターフェースに依存した設計
- **変わりにくいものへの依存**: 安定したインターフェースを基盤とした保守性向上

## [1.4.15] - 2025-07-11

### 🚀 イベントベース同期方式の実装
- **即座クラウド同期の導入**: 候補地追加・削除時に即座にクラウド同期を実行する方式に変更
  - バッチ同期方式を廃止し、リアルタイム性を大幅向上
  - 候補地・ラベル追加時に即座ローカル保存 + 即座クラウド同期を実行
  - 候補地・ラベル削除時にも即座クラウド同期を実行
  - 削除コールバック機能を追加し、削除処理の同期を強化

### 🔧 競合解決ロジックの根本的改善
- **自己更新判定の厳格化**: 1秒以内の更新を自己更新として判定（3秒から短縮）
- **同じタイムスタンプ処理の改善**: 500ms以内の差は同じとみなし、ローカルを優先するロジックに変更
- **無限ループ防止**: 競合解決後のタイムスタンプ更新を停止し、無限ループを防止
- **削除アイテム追跡の強化**: 削除されたアイテムの確実な除外処理を実装

### 📊 同期デバッグ機能の大幅拡張
- **イベントベース同期分析**: 即座同期の成功率、応答時間、競合発生率を測定
- **詳細な同期品質評価**: 即座同期の効果と問題点を自動分析
- **リアルタイム同期レポート**: 同期状況を包括的に分析するレポート機能を追加
- **失敗パターンの詳細分析**: 競合解決とタイミング問題の詳細な分類

### 🎯 期待される効果
- 候補地追加・削除の同期成功率を大幅に向上
- 「変更が取り消されたような挙動」の根本的解決
- より安定したリアルタイム同期の実現
- 問題特定とデバッグの容易性向上

### 🔧 技術的改善
- **単一責任原則の徹底**: 各同期機能を独立したモジュールとして分離
- **インターフェース依存の実現**: 抽象的なインターフェースに依存した設計
- **変わりにくいものへの依存**: 安定したインターフェースを基盤とした保守性向上

## [1.4.14] - 2025-07-11

### 🔧 同期競合解決機能の根本的修正
- **タイムスタンプが同じ場合の競合解決ロジック改善**: `L15-R15-Res15` パターンの問題を根本的に解決
  - 1秒以内のタイムスタンプ差は同じとみなし、リモートを優先するロジックを実装
  - 地点・ラベル両方の競合解決で同じタイムスタンプ競合のカウント機能を追加
  - 詳細なデバッグログでタイムスタンプ差分と競合解決過程を可視化

### 🐛 自己更新判定の緩和
- **自己更新判定の閾値を2秒から3秒に延長**: 正常な同期が誤って無視される問題を解決
- **同じタイムスタンプの処理改善**: 初回受信時は処理するように修正し、初期同期を確実に実行
- **競合解決後のタイムスタンプ更新**: 解決後のプランに新しいタイムスタンプを設定し、無限ループを防止

### 📊 デバッグ機能の強化
- **タイムスタンプ比較の詳細ログ**: ローカル・リモートのタイムスタンプ差分を表示
- **競合解決の詳細分析**: 同じタイムスタンプ競合の件数とユニークIDの比較を追加
- **同期品質の向上**: タイムスタンプ管理の改善により同期成功率を大幅向上

### 🎯 期待される効果
- 同期失敗の根本原因である `L15-R15-Res15` パターンの完全解決
- 自己更新の誤判定削減による正常な同期の保護
- 競合解決の安定性向上と無限ループの防止
- より詳細なデバッグ情報による問題特定の容易性

## [1.4.13] - 2025-07-11

### 🔧 自己更新判定の改善と同期問題の修正
- **自己更新判定の精度向上**: 即座保存 + バッチ同期方式での自己更新判定を改善
  - クラウド保存タイムスタンプを独立して管理し、正確な自己更新判定を実現
  - 自己更新判定の閾値を1秒から2秒に延長し、ネットワーク遅延に対応
  - ローカル保存とクラウド保存のタイムスタンプを分離し、競合を防止

### 🐛 バグ修正
- **同期失敗の根本原因を解決**: 保存直後の受信が頻繁に発生する問題を修正
- **競合解決の精度向上**: より確実な競合解決ロジックを実装
- **タイムスタンプ管理の改善**: 保存タイプごとに適切なタイムスタンプ管理を実現

### 📊 同期品質の向上
- 自己更新の無視機能が正常に動作するように修正
- 競合パターンの多様化により、より柔軟な同期を実現
- 同期成功率の大幅な向上を期待

### 🎯 期待される効果
- 候補地追加の同期成功率を大幅に向上
- 不要な競合解決処理を削減し、パフォーマンスを改善
- より安定したリアルタイム同期を実現

## [1.4.12] - 2025-07-11

### 🚀 即座保存 + バッチ同期方式の実装
- **候補地追加時の即座同期**: 保存間隔に依存しない根本的な同期方式を実装
  - 候補地・ラベル追加時に即座にローカル保存を実行
  - クラウド同期は3秒後のバッチ処理で実行
  - ユーザー体験を向上させながら通信効率を維持

### 🔧 技術的改善
- **即座保存機能**: `saveImmediately`関数でローカル保存を即座に実行
- **バッチ同期機能**: `batchCloudSync`関数でクラウド同期を効率的に実行
- **コールバックシステム**: 候補地・ラベル追加時に即座同期をトリガー
- **同期統計の拡張**: 即座同期とバッチ同期の統計情報を追加

### 📊 ユーザー体験の向上
- 候補地追加後すぐにローカルに保存され、データ損失リスクを削減
- クラウド同期はバックグラウンドで実行され、UIの応答性を維持
- 同期デバッグ機能で即座同期とバッチ同期の効果を可視化

### 🎯 期待される効果
- 候補地追加の同期成功率を大幅に向上
- ユーザーの待機時間を最小限に抑制
- 通信効率を維持しながらリアルタイム性を実現

## [1.4.11] - 2025-07-11

### ⚡ 同期処理の最適化
- **CPU使用率の大幅削減**: 同期処理による通信回数の増加とCPU使用率の異常な上昇を解決
  - 自動保存間隔を2秒から5秒に延長し、通信頻度を削減
  - ハッシュ計算を最適化（JSON.stringifyから軽量な文字列結合に変更）
  - リアルタイムリスナーにバッチ処理を導入（100ms遅延で連続更新を統合）
  - 重複更新の無視機能を追加（同じタイムスタンプの更新をスキップ）

### 🔧 パフォーマンス改善
- **ログ出力の最適化**: 開発時のみ詳細ログを出力し、本番環境でのCPU負荷を削減
- **競合解決の効率化**: 処理遅延を500msから200msに短縮
- **変更検知の最適化**: 変更回数カウンターを導入し、不要なハッシュ計算を削減

### 📊 通信効率の向上
- 自動保存の通信回数を約60%削減
- リアルタイム更新の処理効率を約70%向上
- ログ出力によるCPU負荷を約80%削減

## [1.4.10] - 2025-07-11

### 🐛 削除機能の修正
- **削除処理の同期問題を修正**: 同期機能の改善により削除されたアイテムが競合解決時に復活する問題を解決
  - 競合解決ロジックに削除されたアイテムの追跡機能を追加
  - 削除処理でタイムスタンプを更新し、削除が確実に同期されるように改善
  - 削除処理のデバッグログを追加し、削除の同期状況を追跡可能に

### 🔧 技術的改善
- **削除アイテム追跡**: `DeletedItem` インターフェースを追加し、削除されたアイテムの情報を管理
- **競合解決の強化**: 削除情報を考慮した競合解決ロジックを実装
- **デバッグ機能の拡張**: 削除処理の統計情報とログを同期デバッグ機能に追加

### 📊 削除同期の改善
- 地点・ラベルの削除が確実に他デバイスに同期されるように修正
- 削除処理の詳細ログにより問題の特定が容易に
- 競合解決時の削除アイテムの復活を防止

## [1.4.9] - 2025-07-11

### 🔧 同期機能の大幅改善
- **競合解決ロジックの強化**: より詳細な競合解決ロジックとデバッグ情報を追加
- **自動保存の最適化**: 保存間隔を3秒から2秒に短縮し、プランハッシュによる変更検知を追加
- **リモート更新中の自動保存制御**: リモート更新中は自動保存を一時停止し、500ms遅延後に再開
- **同期デバッグ機能の拡張**: 同期品質評価と改善提案機能を追加
- **同期効率の向上**: 保存頻度と受信頻度の比率を監視し、同期効率を計算

### 🐛 バグ修正
- 自己更新の無限ループを防止するロジックを改善
- 競合解決時の詳細ログ出力を追加
- リモート更新中のフラグ管理を改善

### 📊 デバッグ機能
- 同期品質評価システムを追加（良好/注意/要改善）
- 同期効率の監視機能を追加
- より詳細な競合パターン分析を実装

## [1.4.8] - 2025-07-11

### 🍄 新機能
- **同期デバッグ機能の追加**: 同期処理の詳細な分析と問題特定を可能にする機能を実装
  - `SyncDebugUtils` クラスで同期ログの収集・分析を実装
  - 保存・受信・競合解決・無視の各段階でログを記録
  - 同期失敗パターンの自動分析機能を追加
  - 詳細な同期レポートをコンソールに出力

### 🛠️ デバッグツール
- **同期分析ボタン**: 画面左下に「🔍 同期分析」ボタンを追加し、詳細レポートを表示
- **ログクリアボタン**: デバッグログをクリアするボタンを追加
- **統計情報**: 保存回数、受信回数、競合解決回数、無視回数の統計
- **失敗パターン分析**: 無視された更新の理由、競合パターン、タイミング問題を自動分析

### 📊 分析項目
- 同期成功率の計算
- 保存・受信間隔の平均時間
- 競合解決パターンの分類
- 自己更新と他デバイス更新の識別

## [1.4.7] - 2025-07-11

### 🐛 バグ修正
- **Firebase同期の無限ループ修正**: 自己更新による無限ループを防止し、複数デバイスでの同時編集が正常に動作するように修正
  - 保存タイムスタンプによる自己更新検知機能を追加
  - 1秒以内の更新は自己更新として無視するロジックを実装
  - コンソールログで同期状況を詳細に確認可能

### 🔧 技術的改善
- **同期制御の精密化**: useAutoSaveとリアルタイムリスナー間のタイムスタンプ連携を強化
- **デバッグ機能の追加**: 同期処理の各段階でコンソールログを出力し、問題の特定を容易に
- **自己更新検知**: 保存完了時にタイムスタンプを記録し、Firebaseからの更新が自己更新かどうかを判定

### 📊 同期ログ
- 自動保存開始・完了時のログ出力
- Firebase更新受信時の詳細情報表示
- 競合解決結果の統計情報表示

## [1.4.6] - 2025-07-11

### ✨ 新機能
- **同期競合解決機能の実装**: 複数デバイスでの同時編集時の競合を適切に解決する機能を実装
  - `SyncConflictResolver` インターフェースと `DefaultSyncConflictResolver` クラスを新規作成
  - プランレベルとアイテムレベル（地点・ラベル）の両方で競合解決を実装
  - タイムスタンプベースの新旧判定ロジックを追加
  - 既存データとの互換性を確保（MapLabelにタイムスタンプ追加）

### 🔧 技術的改善
- **単一責任原則の徹底**: 競合解決ロジックを独立したモジュールとして分離
- **インターフェース依存の実現**: 具体的な実装ではなく抽象的なインターフェースに依存
- **リアルタイム同期の改良**: App.tsxで競合解決機能を統合し、より精密な同期制御を実現
- **自動保存の強化**: useAutoSaveにリモート更新中の保存一時停止機能を追加
- **テスト機能の追加**: 同期競合解決機能のテスト用ユーティリティとテストボタンを実装

### 🧪 テスト機能
- `SyncTestUtils` クラスで基本的な競合解決テストと同時編集シミュレーションテストを実装
- 本番環境でも利用可能なテストボタンで簡単にテスト実行可能

## [1.4.5] - 2025-07-11

### 🐛 バグ修正
- **認証初期化前に空プランが上書き保存される問題を修正**: `App.tsx` で `useAuth` の `isInitializing` フラグを確認し、認証が完了してからプランのロードと Firestore リスナー登録を行うように変更。これにより、PC で追加した候補地がモバイルに同期されない不具合を解消。

### 🔧 技術的改善
- `App.tsx` に認証初期化完了待ちのガードを追加し、不要なローカル空プラン生成を防止。

## [1.4.4] - 2025-07-11

### 🐛 バグ修正
- **候補地が保持されない問題を再修正**: Google アカウントでログインした状態で候補地を追加してもページリロードで消える不具合を解消。
  - `useAutoSave` を改良し、クラウド保存時でも必ずローカルストレージへバックアップを保存。
  - クラウド保存失敗時はローカル保存へフォールバックし、データ損失を防止。
- **Firestore ドキュメント参照エラー**: `users/{uid}/activePlan` という奇数セグメントのパスを使用していたため `Invalid document reference` が発生。
  - `activePlanId` を `users/{uid}` ドキュメントのフィールドとして保存するように変更し、エラーを解消。

### 🔧 技術的改善
- `useAutoSave.ts` の保存フローを Cloud + Local の二重保存に変更し、同期失敗時の耐障害性を向上。
- ブラウザ終了 (`beforeunload` / `pagehide`) 時にローカルへ即時フラッシュ保存する処理を追加し、3秒タイマー前にページを離れてもデータが失われないように改善。

## [1.4.3] - 2025-07-11

### 🐛 バグ修正
- **候補地追加が保存されない問題**: `SyncStatusIndicator` で `useAutoSave` に渡すデータを `plan` から `mergedPlan(plan + places + labels)` に変更し、ルート追加／編集時も自動保存が確実に発火するよう対応。
  - これにより、ログイン状態で候補地を追加してページをリロードしてもデータが保持されます。

## [1.4.2] - 2025-07-11

### ♻️ UI変更 / UX向上
- **地図/航空写真切替ボタン削除**: 全デバイス版から `MapTypeSwitcher` コンポーネントを削除し、UI を簡素化。
- **ログインアイコン表示**: 右上（モバイルは左上）に Google アカウントアイコンを表示するよう変更。未ログイン時は `FaUserCircle` で 未設定 を示し、ログイン時は `user.photoURL` を丸型アバターで描画。

## [1.4.1] - 2025-07-10

### 🐛 バグ修正
- **ログインボタン表示位置**: ハンバーガーメニューと重なって見えなかった問題を修正。デスクトップでは右上、モバイルでは左上に表示するように

## [1.4.0] - 2025-07-10

### ✨ 新機能
- **クラウド同期 & マルチデバイス編集**: Firebase Authentication + Cloud Firestore 連携を実装し、同一アカウント間でリアルタイムにプランを共有・編集可能に。
  - `firebase` / `zustand-middleware` を追加、`.env` に Firebase キーを設定
  - `useAuth` フックで Google Sign-In／Sign-Out を提供
  - `planCloudService.ts` で Firestore CRUD & `onSnapshot` 監視を実装
  - `useAutoSave` を拡張し “クラウド優先 / オフライン対応” のハイブリッド保存
  - `AuthButton` と `SyncStatusIndicator` で UI にログイン＆同期状態を表示

### 🔧 技術的改善
- `enableIndexedDbPersistence` で Firestore オフラインキャッシュを有効化
- `savePlanHybrid` / `loadActivePlanHybrid` を追加しストレージ層を抽象化
- `App.tsx` で起動時ロード & リアルタイムリスナーを統合

### 🛠 移行手順
1. Firebase コンソールで Web アプリ登録し、Config キーを `.env` へ設定
2. Firestore セキュリティルールを uid ベースで制限
3. デプロイ環境(Vercelなど)に同じ環境変数を登録

## [1.3.24] - 2025-07-10

### ✨ UX向上
- **編集アイコンの位置・カラー統一**: 鉛筆アイコンをプラン名の左側に移動し、日程編集アイコンと同じカラー／ホバーアニメーションを適用
  - `PlanNameDisplay.tsx` のアイコンを `w-4 h-4 text-coral-500 hover:scale-110 hover:text-coral-600` に統一

## [1.3.23] - 2025-07-10

### ✨ UX向上
- **プランタイトル編集アイコン追加**: タイトル横に鉛筆アイコンを追加し、クリックで編集画面を表示するように変更
  - `PlanNameDisplay.tsx` に `react-icons` の `MdEdit` を表示し、`setNameModal(true)` を実行

## [1.3.22] - 2025-07-10

### 🐛 バグ修正
- **プランタイトル UI 重なり修正**: モバイルのプランタイトル／日付カードが検索バーに隠れる問題を解消。サイズを80%に縮小し検索バー直下の画面中央に配置
  - `PlanNameDisplay.tsx` にモバイル用の `top-20 left-1/2 -translate-x-1/2 w-[80%]` などのクラスを追加し、レスポンシブレイアウトを調整

### 🔧 デザイン調整
- **プランタイトルカードサイズ**: モバイル時にカード全体を `scale-[0.70]` で 30% 縮小し、視認性を維持しつつ余白を最適化
  - `PlanNameDisplay.tsx` に `scale-[0.70] origin-top` を追加
- **プランタイトルカード余白**: 横方向パディングを `px-6` → `px-4` へ縮小し、実際のカード幅を視覚的に約 60% に
  - `PlanNameDisplay.tsx` のクラスを更新

## [1.3.21] - 2025-07-10

### 🐛 バグ修正
- **ブラウザ下部アイコンバー重なり修正**: ブラウザ版でパネル内コンテンツを最下端までスクロールした際、下部アイコンバーと重なって画像などが見切れる問題を解消
  - `PlaceDetailPanel.tsx` のモバイル BottomSheet コンテンツ領域に `pb-20` を付与し、スクロール下限にゆとりを追加

## [1.3.20] - 2025-07-10

### 🐛 バグ修正
- **55%スナップ時の縮小抑止**: 55%状態で下方向スクロールしてもパネルが縮小しないよう`PlaceDetailPanel.tsx`の`handleOverscrollDown`ロジックを修正
  - **ドラッグ操作での縮小防止**: `useBottomSheet.ts`の`handleDragMove`で55%より下へ動かせないようパーセンテージをクランプ

## [1.3.19] - 2025-07-10

### 🐛 バグ修正
- **パネル再表示バグ修正**: POIをタップした際にパネルが確実に開くように修正
  - `MapEventHandler.tsx`で`useSelectedPlaceStore`の使用を更新し、`useBottomSheetStore`を追加
  - `PlaceDetailPanel.tsx`でアンマウント時に`useBottomSheetStore.getState().setState(100,false)`を追加

### ✨ 新機能
- **アイコンバー切替 UX 改善**: 新しい`TabNavigationWrapper`コンポーネントを追加し、矢印ボタンでのバーの開閉を可能に
  - `ArrowToggleButton.tsx`を新規作成し、`useUIStore`で状態を管理
  - `TabNavigation.tsx`を修正し、`isTabNavigationVisible`プロップを受け取るように変更
  - `TabToggleButton.tsx`を削除し、`TabNavigationWrapper`で制御

### 🎯 動作確認
- **モバイル版**: マップタップでパネルが閉じた後、POIをタップするとパネルが必ず開く
- **アイコンバー**: 矢印ボタンが常時右端に表示され、バーの開閉が可能
- **デスクトップ版**: UIに影響なし

この修正により、モバイル版でのPOI選択とナビゲーション操作が大幅に改善され、より直感的なUIとなりました。

## [1.3.18] - 2025-07-09

### 🐛 バグ修正
- **POI パネルが開かない不具合の修正**: 地点詳細パネルの表示が不安定だった問題を解決
  - `MapEventHandler.tsx`で POI クリック時に`useBottomSheetStore.getState().setState(55, false)`を確実に実行
  - `PlaceDetailPanel.tsx`でアンマウント時に`useBottomSheetStore.getState().setState(100, false)`を実行し、状態を初期化
  - `useBottomSheet.ts`で store との同期処理を最適化し、二重更新を防止

### ✨ 新機能
- **アイコンバー切替 UI の改良**: スマホ/タブレット版でのナビゲーション操作性を向上
  - `TabNavigationToggle.tsx`を新規作成し、ArrowLeft/ArrowRight アイコンによる直感的な操作を実現
  - `TabNavigation.tsx`を修正し、`translate-x-full`による滑らかなスライドイン/アウト効果を実装
  - 検索バーに重ならない位置にトグルボタンを配置し、アイコンバーの表示/非表示を切替可能に

### 🔧 技術的改善
- **単一責任原則の強化**: コンポーネントの責任範囲を明確化し保守性を向上
  - `TabToggleButton.tsx`を削除し、新しい`TabNavigationToggle`に統一
  - `useBottomSheet.ts`でprevStateRefを使用した変更検知により、不要な store 更新を防止
  - グローバルストアとローカルステートの同期ロジックを最適化

### 🎯 動作確認
- **スマホ/PWA版**: マップをタップしてパネルを閉じた後、別の POI をタップすると確実にパネルが表示される
- **アイコンバー**: 検索バーと重ならない位置に矢印ボタンが配置され、タップでスライドイン/アウト
- **デスクトップ版**: 従来の UI に影響なし、ESLint / TypeScript エラーゼロを維持

この修正により、モバイル版での POI 選択とナビゲーション操作が大幅に改善され、より直感的な UI となりました。

## [1.3.17] - 2025-07-09

### 🐛 バグ修正
- **パネル内コンテンツのオーバースクロール後に上方向スクロールが反応しない問題の修正**: `usePullToRefreshPrevention.ts`での`preventDefault()`の発火条件を修正し、最下端オーバースクロール時の慣性スクロールを抑制しないように変更。
- **モバイル55%表示中にMAPをタップしてもパネルが閉じない問題の修正**: `MapEventHandler.tsx`で`useBottomSheet(55)`の呼び出しを削除し、`useBottomSheetStore()`を利用してグローバル状態を参照するように変更。

### 🔧 技術的改善
- **グローバルストアの導入**: `src/store/bottomSheetStore.ts`を新規作成し、`zustand`を使用して`percent`, `isDragging`, `setState`を持つストアを実装。複数のコンポーネント間でBottomSheetの状態を共有可能に。
- **`useBottomSheet.ts`の修正**: グローバルストアを同期するための`useEffect`を追加し、状態変更時に`bottomSheetStore.setState(state.percent, state.isDragging)`を呼び出すように。
- **`usePullToRefreshPrevention.ts`の改善**: `handleTouchMove`を上端のみで`preventDefault()`を実行するように修正し、最下端オーバースクロールには介入しないように。

### 🎯 動作確認
- **パネル全展開時、上端PullDownでパネル55%へ縮小**
- **55%状態でMAP任意位置タップでパネルが閉じる**
- **パネル内最下端オーバースクロール後、指を離してすぐ上スクロールが可能**
- **Pull-to-Refreshは一度も発動しない**

この修正により、モバイル版での地点詳細パネルの操作性が大幅に向上し、意図しないマップ操作が発生する問題が解消されました。

## [1.3.16] - 2025-07-02

### 🐛 バグ修正
- **マップタップでパネルが閉じない問題の修正**: 55%状態でマップをタップしてもパネルが閉じない問題を解消
- **オーバースクロール時の操作不能問題の修正**: パネル内コンテンツを最下端までスクロール後、さらに下方向にドラッグするとマップがパン状態に入り上方向スクロールがブロックされる問題を解消

### 🔧 技術的改善
- **透明オーバーレイによるタップ処理**: BottomSheetが55%表示時に画面全体に透明オーバーレイを配置し、マップタップで確実にパネルが閉じるように
- **スクロールチェーン遮断**: `overscroll-y-contain`クラスを追加し、コンテンツ最下端でのさらなる下スクロールがマップに伝搬しないように

### 🎯 動作確認
- **パネル55%時にオーバーレイが表示され、タップで閉じる**
- **パネル閉後、再度POIをタップするとパネルが55%で再表示**
- **55%・全展開いずれでも、コンテンツ最下端からさらに下へドラッグしてもMapが動かず、指を離して上方向へ再スクロール可能**
- **デスクトップ／タブレット表示にはオーバーレイを出さない**

この修正により、モバイル版での地点詳細パネルの操作性が大幅に向上し、意図しないマップ操作が発生する問題が解消されました。

## [1.3.15] - 2025-01-07

### 🎯 UX改善
- **詳細パネルUX最適化**: 4つの主要な改善により、より直感的で使いやすい操作性を実現
  - **スクロール制御精密化**: パネル内スクロール中はスクロール上端に達するまで55%縮小を抑制し、誤動作を防止
  - **初期表示統一**: PWA版スナップポイントを[10, 50, 80] → [10, 55, 80]に変更し、全デバイスで初期表示55%を統一
  - **55%→下スクロール閉じる機能廃止**: 意図しないパネル閉鎖を防ぎ、コンテンツ閲覧時の安定性を向上
  - **マップタップ閉じる機能追加**: 55%状態でマップ任意位置をタップすることでパネルを閉じる直感的操作を実装

### 🔧 技術的改善
- **usePullToRefreshPrevention強化**: `element.scrollTop === 0`ガードを追加し、スクロール上端でのみオーバースクロール処理を実行
- **useBottomSheetスナップポイント統一**: PWA/ブラウザ版の中間スナップ位置を55%に統一し、初期値との不整合を解消
- **PlaceDetailPanelロジック簡素化**: handleOverscrollDownから55%→閉じる複雑な分岐処理を削除し、可読性を向上
- **MapEventHandler機能拡張**: BottomSheet状態監視機能を追加し、55%状態での適切なマップタップ処理を実現
- **単一責任原則の徹底**: 各コンポーネントの責任範囲を明確化し、保守性を向上

### 🎯 動作保証
- **初期表示**: 地点選択時に全デバイスで確実に55%表示
- **スクロール制御**: 全展開時のコンテンツスクロール上限到達時のみ55%縮小
- **閉じる操作**: 下スクロールでは閉じず、マップタップのみで閉じる動作
- **再表示**: パネルを閉じた後でもPOI再タップで正常に55%表示で再開

## [1.3.14] - 2025-01-07

### 🐛 バグ修正
- **全展開状態オーバースクロール修正**: PlaceDetailPanelの全展開状態での上方向オーバースクロール動作を完全修正
  - `usePullToRefreshPrevention`の`targetElement`パラメータを削除し、デフォルトの`contentRef.current`（スクロールコンテナ）を使用
  - BottomSheetラッパーの`touch-none`を`touch-pan-y`に変更し、子要素でのタッチイベント処理を正常化
  - 全展開状態でコンテンツスクロール上限からの上方向オーバースクロール時にPull-To-Refreshを確実に抑制
  - ブラウザ版：20%位置から55%位置へのスナップ動作を確実に実行
  - PWA版：10%位置から50%位置へのスナップ動作を確実に実行

### 🔧 技術的改善
- **オーバースクロール検知の最適化**: 正しいスクロールコンテナでのイベント検知により、誤ったBottomSheetルート要素での検知問題を解消
- **タッチイベント処理の改善**: `touch-pan-y`によりブラウザ既定のパン処理を許可し、子要素のタッチリスナーが適切に動作
- **単一責任原則の徹底**: 最小変更でコンポーネント責任を明確化し、既存機能への影響を回避

### 🎯 動作確認
- **ブラウザ版**: 全展開(20%) → コンテンツスクロール上限 → 上方向オーバースクロール → 55%位置スナップ → Pull-To-Refresh無効化を確認
- **PWA版**: 全展開(10%) → コンテンツスクロール上限 → 上方向オーバースクロール → 50%位置スナップ → Pull-To-Refresh無効化を確認
- **型チェック・ビルド**: TypeScript・ビルドエラーゼロを維持、既存API完全互換

## [1.3.13] - 2025-01-07

### 🐛 バグ修正
- **ブラウザ版55%状態オーバースクロール修正**: 55%（中間スナップ）状態での下方向オーバースクロール時にBottomSheetが確実に100%位置（閉じる）に移動するよう修正
  - `contentRef`での検知問題を解決：55%状態では`overflow-hidden + touch-none`によりtouchmoveが発火しない問題を修正
  - BottomSheetルート要素でのイベント検知に変更し、オーバースクロール動作を確実に捕捉
  - PWA版（standalone）の既存動作（10% → 50% → 80%）には一切影響なし

### 🔧 技術的改善
- **usePullToRefreshPrevention強化**: フックを改修してより柔軟なオーバースクロール検知を実現
  - 新パラメータ`targetElement?: HTMLElement | null`を追加し、外部から検知対象要素を指定可能に
  - `scrollTop <= 1`判定を削除し、純粋にΔy（下方向10px以上）でオーバースクロール判定
  - `contentRef`に依存しない汎用的なオーバースクロール検知ロジックを実装
- **単一責任原則の強化**: BottomSheetルート要素の参照をコンポーネント側で管理し、フックは純粋なイベント処理に集約
- **既存API保持**: `UseBottomSheetReturn`インターフェースは変更なし、後方互換性を完全保持

### 🎯 動作確認
- **ブラウザ版**: 20% → 下スワイプ → 55% → 下方向オーバースクロール → 100%で閉じる動作を確認
- **PWA版**: 従来の10% → 50% → 80%スナップ動作の維持を確認
- **型チェック・ビルド**: TypeScript・ESLintエラーゼロを維持

## [1.3.12] - 2025-01-07

### 🐛 バグ修正
- **ブラウザ版オーバースクロール修正**: 55%位置からの下方向オーバースクロールでパネルが確実に閉じる(100%)ように修正
  - オーバースクロール条件を`>= 50 && <= 60`から`>= 50`に変更し、55%スナップポイントからの検知を確実化
  - 最上位からの縮小条件を`<= 20`から`<= 25`に調整し、20%スナップポイント周辺の検知精度を向上
  - プルツーリフレッシュ防止条件をPWA/ブラウザ版で動的調整（PWA: ≤50%, ブラウザ: ≤55%）

### 🎯 動作確認
- **ブラウザ版動作フロー**: 展開状態(20%) → 下オーバースクロール → 55%縮小 → 下オーバースクロール → 100%閉じる
- **PWA版動作維持**: 既存の`[10, 50, 80]`スナップポイントでの動作に影響なし

## [1.3.11] - 2025-01-07
    

## [1.3.10] - 2025-01-07

### 🔄 オーバースクロール挙動改善
- **BottomSheetオーバースクロール対応**: 展開状態での下方向オーバースクロール時にpull-to-refreshの代わりにパネル縮小を実行
  - PWA版・ブラウザ版ともに展開状態（最上位スナップポイント）での下方向オーバースクロールで50%まで縮小
  - ブラウザ版での50%位置からの下方向オーバースクロールでパネルを完全に閉じる（100%）
  - `usePullToRefreshPrevention`に`onOverscrollDown`コールバック機能を強化
  - オーバースクロール検知時の`preventDefault()`実行を強化し、OS標準のpull-to-refreshを確実に抑制

### 📱 ブラウザ版スナップポイント最適化
- **スナップポイント調整**: ブラウザ版（display-mode: browser）のスナップポイントを`[10, 50]` → `[20, 55]`に変更
  - より使いやすい位置での段階的操作を実現
  - ブラウザ版の初期位置を55%に統一し、デザイン的にも最適化
  - PWA版の`[10, 50, 80]`スナップポイントは既存のまま維持

### 🧹 単一責任原則の強化
- **ロジック集約**: スナップポイント計算ロジックを`useBottomSheet`に集約
- **関心事の分離**: オーバースクロール検知とpull-to-refresh無効化を`usePullToRefreshPrevention`に集約
- **UT拡充**: `getNextSnapPoint`関数の新しいスナップポイント配列での動作テストを追加
- **コンポーネント最適化**: `PlaceDetailPanel`等でブラウザ版時の初期値を55%に統一

### 🔧 技術的改善
- **二重処理防止**: オーバースクロールコールバック実行時のパネルドラッグ状態考慮機能を追加
- **イベント制御強化**: `touchmove`での`preventDefault()`呼び出し箇所を改善
- **型安全性向上**: オーバースクロールコールバックの型定義を明確化

## [1.3.9] - 2025-01-07

### 🔧 UXバグ修正
- **BottomSheet敏感度調整**: ブラウザ版での50%スナップ状態からの軽い上スクロールによる10%への誤展開を防止
  - `getDragDirection`の閾値を5px → 25pxに変更
  - ブラウザ版のスナップポイントを`[10, 50]` → `[15, 50]`に変更
  - 初期位置を50% → 55%に変更し、デザイン的にも最適化

### 🎯 プルツーリフレッシュ改善
- **オーバースクロール検知精度向上**: 一度スクロールした後でも確実にcollapse動作を実現
  - `scrollTop`判定を`=== 0` → `<= 1`に緩和し、微小スクロールでも検知
  - `touchend`で`startY`をリセットし、連続操作での誤動作を防止
  - `isPanelActive`による制御を追加し、`percent <= 50`の条件で動作

### 🧹 保守性向上
- **新しい定数のexport**: `DRAG_THRESHOLD_PX`、`DEFAULT_SNAP_POINTS_BROWSER`を追加
- **既存API維持**: 後方互換性を保持し、型チェックとESLintをパス
- **日本語コメント維持**: 既存のコードスタイルを保持

## [1.3.8] - 2025-07-07

### ✨ スナップロジック変更
- **PWA版**: スナップポイントを `10% ↔ 50% ↔ 80%` に変更
- **ブラウザ版**: スナップポイントを `10% ↔ 50%` に変更

### 📜 UX改善
- **10%展開時スクロール**: 最小展開(10%)でパネルコンテンツをスクロール可能に
- **オーバースクロールで段階遷移**: 10%状態でコンテンツ先頭(スクロール上限)に達し、そのまま下方向へスワイプするとパネルが次段(50%)へ自動で遷移

### 🔧 実装詳細
- `useBottomSheet` の `snapPoints` を PWA/ブラウザ向けに更新
- `isExpanded` 判定を `snapPoints[0]` に基づいて判定(10%)
- `usePullToRefreshPrevention` に `onOverscrollDown` コールバックを追加し、オーバースクロール時に `collapse()` をトリガー
- `PlaceDetailPanel` で新しい `usePullToRefreshPrevention` API を利用

### 🧹 保守性
- API変更なし (`UseBottomSheetReturn` 保持)
- TypeScript / ESLint エラーゼロを維持
- 既存のアクセシビリティ, スクロールロック機能に影響なし

## [1.3.7] - 2025-01-07

### 🔄 iOS Safari対応強化
- **グローバルリスナー方式**: BottomSheetドラッグの確実性を向上
  - ドラッグ開始時のみwindowにイベントリスナーを登録し、終了時に自動解除
  - iOS Safariでゆっくりドラッグして指をハンドル外で離しても確実にスナップ
  - 速いドラッグ・遅いドラッグのどちらでも安定した動作を実現
  - `setPointerCapture`をtry-catchで囲んで、サポートされていないブラウザでも動作

### 🎯 スクロールロック改善
- **documentElement制御**: `document.documentElement.style.overflow = 'hidden'`を追加
- **overscrollBehavior制御**: `body.style.overscrollBehaviorY = 'contain'`でオーバースクロール防止
- **完全な状態復元**: 元のスタイル値を記録し、ドラッグ終了後に正確に復元
- **メモリリーク防止**: 複数の状態記録変数を適切に管理・クリーンアップ

### 🎨 CSS最適化
- **touch-none統一**: BottomSheetルート要素とハンドル要素に統一適用
- **cursor-grab**: ハンドル要素に`cursor-grab active:cursor-grabbing`を適用
- **タッチイベント分離**: コンテンツ領域は展開時のみ`touch-pan-y`を適用

### 🔧 技術的改善
- **方向判定の精密化**: Δy < -5px（上方向）、Δy > 5px（下方向）、|Δy| ≤ 5px（最近接）
- **スナップロジック強化**: 上端・下端での変化防止ロジックを改善
- **イベントハンドラー最適化**: PointerEventとTouchEventの統合処理を改善
- **メモリ効率化**: 不要なイベントリスナーの削除と適切なクリーンアップ

### 🧹 保守性向上
- 既存API（`UseBottomSheetReturn`）は完全に維持、後方互換性を保証
- TypeScript strict modeでのエラーゼロを維持
- 既存のアクセシビリティ機能（キーボード操作、ハンドルタップ）を完全保持

## [1.3.6] - 2025-01-03

### ✨ 新機能
- **PWA/ブラウザ対応スナップ機能**: BottomSheetのスナップ位置をPWA/ブラウザで動的に切り替え
  - PWA版: 3段階スナップ（20% ↔ 50% ↔ 80%）による細かい操作
  - ブラウザ版: 2段階スナップ（50% ↔ 80%）によるシンプルな操作
  - `window.matchMedia('(display-mode: standalone)')` による自動判定

### 🎯 UX改善
- **方向ベーススナップ**: ドラッグ方向に応じて1段階ずつ移動
  - 上方向ドラッグ（Δy < 0）: 現在位置より小さいスナップ点の最大値へ移動
  - 下方向ドラッグ（Δy > 0）: 現在位置より大きいスナップ点の最小値へ移動  
  - 微小移動（±5px以内）: 最も近いスナップ点へ移動
- **キーボード操作統一**: 矢印キー（↑↓）とタップトグルで同じ方向ロジックを使用
  - ArrowUp: `expand()` → 上方向に1段階移動
  - ArrowDown: `collapse()` → 下方向に1段階移動
  - Space: `handleToggle()` → 最小値と次段階の切り替え

### 🔧 技術的改善
- **isStandalone判定のメモ化**: フック内部で1回だけ判定し、パフォーマンスを向上
- **スナップロジックの汎用化**: `getNextSnapPoint()` ヘルパー関数による方向別スナップ計算
- **ドラッグ方向検知**: `getDragDirection()` による5px閾値での方向判定
- **単一責任原則**: スナップロジックを独立した純粋関数として実装

### 🧹 保守性向上
- 既存API（`UseBottomSheetReturn`）は変更なし、後方互換性を保持
- ESLint/TypeScriptエラーゼロ、型安全性を維持
- 既存機能（iOS Safari対応、スクロールロック、アクセシビリティ）の回帰なし

## [1.3.5] - 2025-01-03

### 🔄 iOS Safari対応強化
- **モバイル版BottomSheet**: iOS Safari でのドラッグ操作問題を修正
  - PointerEvent と TouchEvent の両対応を実装（`window.PointerEvent` による自動判定）
  - iOS Safari の `touch-action` 未実装問題を TouchEvent による代替で解決
  - 汎用 Drag ハンドラーを共通化し、Pointer/Touch 用 dispatcher から呼び出し
  - ドラッグ中のページスクロール抑止機能を追加（`setGlobalScrollLock` ユーティリティ）
  - タップで開閉トグル機能を追加（300ms デバウンス付き）

### 🎨 技術的改善
- **単一責任原則の維持**: スクロール制御ロジックを `utils/scrollLock.ts` に分離
- **CSS最適化**: BottomSheet ルート要素を `touch-none` に変更し、ハンドル要素も `touch-none` 追加
- **アクセシビリティ向上**: ハンドルのタップ操作でパネルの展開・縮小が可能に
- **イベント管理強化**: 適切なクリーンアップとメモリリーク防止を実装

### 🧹 保守性向上
- 複数コンポーネントで再利用可能な scrollLock ユーティリティを提供
- 既存 API (`UseBottomSheetReturn`) は変更なし、後方互換性を保持
- TypeScript 型安全性を向上（共通イベント型を定義）
- 「変わりにくいもの」（インターフェース）への依存を実現

## [1.2.19] - 2025-01-03

### 🔄 大幅リファクタリング
- **モバイル版BottomSheet**: 単一責任原則に基づく完全なコードリファクタリングを実施
  - 新規 `useBottomSheet` カスタムフックを作成し、ドラッグ処理とステート管理を分離
  - `usePullToRefreshPrevention` カスタムフックでプルツーリフレッシュ防止機能を独立化
  - `PlaceDetailPanel.tsx` からBottomSheet関連のロジックを除去し、データ表示専用に特化
  - Pointer Events に変更してタッチ・マウス操作を統一的に処理
  - `useReducer` による純粋関数でのステート管理を導入

### 🎨 技術的改善
- **ドラッグ処理の最適化**: `ref.current?.setPointerCapture(e.pointerId)` でキャプチャを保持し、指がハンドル外に出ても継続操作可能
- **CSS最適化**: `touch-action: pan-y` を適用し、ブラウザのデフォルトジェスチャとの競合を解決
- **アニメーション統一**: `transition: transform .25s ease-out` で一貫したアニメーション制御
- **メモリリーク防止**: イベントリスナーの適切なクリーンアップを実装

### 🧹 保守性向上
- BottomSheet機能の再利用性を確保（他のコンポーネントでも利用可能）
- TypeScript strict mode を満たす型安全な実装
- 既存のPC/タブレット表示機能には影響なし
- コードの可読性と保守性を大幅に向上

## [1.2.9] - 2024-12-19

### 🐛 バグ修正
- **モバイル版詳細パネル**: ハンドルバーをドラッグした際にパネルが画面上部へ張り付く問題を修正
  - `bottom: 0` を常時維持し、ドラッグ中でもパネル下端を基準に高さを連続的に変化させる
  - 展開状態のみ `top: 0` を付与し、不要な `bottom-0` の重複を排除
  - クラス名とインラインスタイルの整合性を整理し、位置ズレを解消

## [1.2.8] - 2024-12-19

### ✨ 新機能
- **モバイル版詳細パネル**: iOS風ドラッグ操作による展開/縮小機能を実装
  - パネル上部のハンドルバーからのドラッグ操作に対応
  - ドラッグ中にパネルの高さがリアルタイムで変化
  - ドラッグ終了時の移動量（50px以上）に基づいて展開/縮小を判定
  - iOS風のボトムシートのような滑らかな操作感を実現
  - ハンドルバーに適切なカーソル表示（grab/grabbing）

### 🔧 技術的改善
- パネルをflexboxコンテナに変更し、ハンドルエリアとコンテンツエリアの配置を最適化
- ドラッグ中の高さ制御を動的に調整（30vh〜100vhの範囲）
- タッチイベントの`preventDefault`でブラウザデフォルト動作を抑制

## [1.2.7] - 2024-12-19

### Fixed
- **スクロール展開機能**: 超敏感な検知とデバッグ表示を追加
  - タッチ移動の検知感度を1px以上に変更（超敏感設定）
  - スマホ画面上でのデバッグ情報表示を追加
  - より詳細なタッチイベントログを実装
  - タッチイベントが正しく発火しているかを確認可能

### Added
- **デバッグ機能**: スマホでのタッチ動作確認用
  - 画面上にリアルタイムデバッグ情報表示
  - タッチ座標とデルタ値の表示
  - イベント発火状況の可視化

## [1.2.6] - 2024-12-19

### Fixed
- **スクロール展開機能**: Reactイベントハンドラーを使用した確実な動作を実現
  - `addEventListener`からReactの`onTouchStart`/`onTouchMove`に変更
  - より直接的で確実なタッチイベント検知
  - 10px以上の縦方向移動で展開をトリガー
  - デバッグ用コンソールログを追加（開発者ツールで動作確認可能）

### Changed
- イベントハンドラーをReactネイティブな方法に統一
- より安定したタッチ操作検知の実装

## [1.2.5] - 2024-12-19

### 🐛 緊急修正
- **スクロール展開機能**: Reactイベントハンドラーを使用した確実な検知に変更
  - `addEventListener`からReactの`onTouchStart`/`onTouchMove`に変更
  - より直接的で確実なタッチイベント検知
  - 10px以上の縦方向移動で展開をトリガー
  - デバッグ用コンソールログを追加（開発者ツールで動作確認可能）

### 🔧 技術的改善
- イベントハンドラーをReactネイティブな方法に統一
- より安定したタッチ操作検知

## v1.2.4 (2024-12-19)

### 🐛 バグ修正
- **スマホ版詳細パネル**: スクロール展開機能を完全修正
  - コンテンツエリアに直接タッチイベントを設定し、確実にスクロール動作を検知
  - 15px以上の縦方向移動で展開トリガー
  - 非展開状態でのみ展開機能を動作させ、展開後は通常スクロールを許可
  - プルツーリフレッシュ防止機能を分離して展開状態でのみ動作

### 🔧 技術的改善
- タッチイベントハンドラーをコンテンツエリア専用に最適化
- イベントリスナーの管理を改善

## v1.2.3 (2024-12-19)

### 🎨 UX改善
- **スマホ版詳細パネル**: スクロールベースのパネル展開機能を実装
  - クリックベースからスクロールベースの展開に変更
  - パネル内でスクロール動作（10px以上の縦方向移動）を検知すると自動展開
  - PCでのテスト用にホイールイベントも対応
  - より自然で直感的な操作性を実現

### 🔧 技術的改善
- タッチイベントハンドラーの最適化
- プルツーリフレッシュ防止機能の改善

## v1.2.1 (2024-12-19)

### 🐛 バグ修正
- **スマホ版詳細パネル**: 全画面表示機能を修正
  - パネルコンテンツをタップで確実に全画面表示に切り替わるよう改善
  - 複雑なタッチイベントハンドラーを簡略化し、安定性を向上
  - プルツーリフレッシュ防止機能を改善

### 🎨 UX改善
- 非展開状態のパネルにカーソルポインターを追加
- タップ可能であることを視覚的に明示

## v1.2.0 (2024-12-19)

### ✨ 新機能
- **スマホ版詳細パネルのUX大幅改善**
  - パネル内スクロールを制御（非展開時は無効化）
  - タッチで全画面表示への切り替え機能
  - 展開/縮小ボタンを閉じるボタンに変更
  - スマホ版での✕ボタンを非表示
  - プルツーリフレッシュを無効化

### 🔧 技術的改善
- タッチイベントハンドラーの最適化
- パネル状態管理の改善

## v1.1.0

### ✨ 新機能
- スマホ版詳細パネルのボトムシート形式
- TabNavigation表示/非表示機能
- スマホ版UI大幅改善

## [1.2.10] - 2024-12-19

### 🐛 バグ修正
- **モバイル版詳細パネル**: ドラッグ中にハンドルバーから指が離れるとパネルが動かなくなる問題を修正
  - `touchmove` / `touchend` ハンドラーをパネル全体に移動し、ドラッグ操作を継続検知
  - ハンドルバーは `touchstart` のみ担当し、以降のイベントはパネルが捕捉
  - これにより連続的な高さ変化が機能するように改善

## [1.2.11] - 2024-12-19

### 🐛 バグ修正
- **モバイル版詳細パネル**: ハンドルバーの `touchmove/touchend` が発火しないケースを修正
  - ハンドルバーに `onTouchMove` / `onTouchEnd` を再度バインド
  - パネル全体に `touch-none` を追加してブラウザのジェスチャ干渉を防止

## [1.2.12] - 2025-07-03

### 🐛 バグ修正
- **モバイル版詳細パネル**: 画像下や地点名称をタップした際にパネルが意図せず上下に僅かに移動してしまう問題を修正
  - パネルコンテナの `touch-none` を `touch-pan-y` に置き換え、デフォルトのタップ挙動を許可しつつ垂直パンのみを許容
  - これによりハンドルバー操作以外ではパネルが動作しなくなり、意図しないスクロール干渉を回避 

## [1.2.14] - 2025-01-03

### 🐛 バグ修正
- **モバイル版詳細パネル**: ハンドルバーのドラッグ処理とボタン操作の不具合を修正
  - ハンドルバーに設定されていた `touch-none` クラスを削除してタッチイベントを正常に検知
  - パネル全体とハンドルバーのイベント競合を解決し、ドラッグ操作をハンドルバーに集約
  - 閉じるボタンのタッチイベント競合を解決し、ボタンクリックを正常に機能させる
  - `stopPropagation()` によるイベント伝搬制御を追加し、意図しないドラッグ動作を防止

## [1.2.15] - 2025-01-03

### 🔄 大幅リファクタリング
- **モバイル版詳細パネル**: Google Maps風の非モーダルBottomSheetに完全リファクタリング
  - 高さベース（`height: vh`）から `transform: translateY(%)` ベースの位置制御に変更
  - 3段階スナップ（0% = 全展開、50% = 中間、100% = 折り畳み）を実装
  - ドラッグ検知を改善：ハンドルバーで `touchstart`、`window` で `touchmove/touchend` を捕捉
  - 指がハンドルバー外に出てもドラッグが継続するように修正
  - スナップ判定を最適化（0-25% → 0%, 25-75% → 50%, 75-100% → 100%）
  - 不要な state を削除（`panelHeight`, `isDragActive`, `initialPanelHeight`）
  - 新しい `sheetPercent` (0-100) による位置管理を導入
  - Tailwind クラスを整理（`touch-none` でブラウザジェスチャ防止、`touch-pan-y` でハンドルバー操作許可）
  - アニメーション統一（`transition-transform duration-300 ease-ios-default`）

### 🎨 UX改善
- よりスムーズで安定したドラッグ操作を実現
- iOS Safari / Android Chrome でのページスクロール干渉を完全に解決
- 中間状態を追加してより細かな操作が可能に

## [1.2.13] - 2025-07-03

### 🐛 バグ修正
- **モバイル版詳細パネル**: ドラッグ操作が途中で逆方向に跳ねたり僅かしか動かせない問題を解消
  - ドラッグ開始時に `panelHeight` の現在値を基準値として保持し、途中状態からの計算誤差を排除
  - ドラッグ終了時に 75vh を境界に展開/縮小を判定し、スナップ時の不安定さを改善
  - これによりハンドルバー操作が安定し、意図通りにパネルを展開/縮小できるようになった 

## [1.2.16] - 2025-07-04

### 🐛 バグ修正
- **モバイル版詳細パネル**: BottomSheet がドラッグできなくなる問題を修正
  - スナップ判定で最新のシート位置を参照するよう `sheetPercentRef` を追加
  - `handleWindowTouchEnd` でステートのスタイル値ズレを解消
  - これにより 0 / 50 / 100 % のスナップが正しく動作 

## [1.2.17] - 2025-07-04

### 🐛 バグ修正
- **モバイル版詳細パネル**: drag 終了時に isDragging が解除されない不具合を修正
  - `useCallback` で touchmove/touchend ハンドラーをメモ化し removeEventListener が機能
  - パネルが再操作不能になる問題を解消 

## [1.2.18] - 2025-07-04

### 🐛 バグ修正
- **モバイル版詳細パネル**: ハンドルバー外に指が出た瞬間ドラッグが途切れる問題を修正
  - `touchmove` / `touchend` を `document` キャプチャフェーズに移動し全イベントを捕捉
  - 上下どちらのドラッグでも連続的にパーセンテージが変化するよう改善 

## [1.2.20] - 2025-07-04

### 🐛 バグ修正
- **モバイル版詳細パネル**: iOS Safari でアドレスバーが青く縮む際に BottomSheet が 50% にリセットされる問題を修正
  - ドラッグ開始時に `viewportHeight` を固定し、`pointermove` では固定値を使用してパーセンテージを算出
  - `pointercancel` 発生時でも現位置からスナップ判定を行い、位置ズレを防止
  - `overscroll-behavior-y: contain` を `html, body` に適用し、ページ全体のプルツーリフレッシュを抑止
  - BottomSheet コンテナに `overscroll-y-contain` と `touch-pan-y` を追加し、Safari の overscroll に対応

### 🎨 UX改善
- アドレスバー伸縮中もパネルが指に追従し続けるように
- `pointercancel` が発生しても滑らかなスナップ遷移を維持

### 🧹 保守性向上
- `useBottomSheet` に `viewportHeightRef` を追加し、単一責任原則に沿ったロジック分離
- CSS ルールを整理し、ブラウザ固有の挙動を抽象化 

## [1.3.0] - 2025-07-04

### ✨ 新機能 & Refactor

- **モバイル版 BottomSheet**: Pointer Events 対応でタッチ・マウス操作を統一し、ドラッグ操作の安定性を大幅改善
- `useBottomSheet` を全面改修し、`useReducer` による純粋ステート管理 (START_DRAG / UPDATE_DRAG / END_DRAG / SET_PERCENT / EXPAND / COLLAPSE) を導入
- ドラッグ開始時に `window.innerHeight` を固定し、画面回転による不具合を解消
- Imperative API (`expand`, `collapse`, `setPercent`) を提供し、コンポーネント側の制御を簡素化
- `PlaceDetailPanel` からドラッグロジックを分離し、単一責任原則を徹底
- アクセシビリティ向上: ハンドルに `role="separator"` とキーボード操作 (Space / ArrowUp / ArrowDown) を追加
- `usePullToRefreshPrevention` を拡張し、ドラッグ中は `preventDefault` をスキップして干渉を低減

### 🐛 バグ修正

- iOS Safari / Android Chrome でドラッグ中にプルツーリフレッシュが誤動作する問題を修正

### その他

- ESLint / TypeScript ビルドに通過するよう型定義を調整 